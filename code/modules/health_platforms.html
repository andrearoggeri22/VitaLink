
<!doctype html>
<html lang="it" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation of VitaLink API">
      
      
        <meta name="author" content="Andrea Roggeri">
      
      
      
        <link rel="prev" href="email_utils.html">
      
      
        <link rel="next" href="health_platforms_config.html">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Health Platforms - VitaLink Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#app.health_platforms" class="md-skip">
          Vai al contenuto
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Intestazione">
    <a href="../index.html" title="VitaLink Documentation" class="md-header__button md-logo" aria-label="VitaLink Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            VitaLink Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Health Platforms
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Cancella" aria-label="Cancella" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inizializza la ricerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/andrearoggeri22/VitaLink" title="Apri repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    VitaLink
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="api.html" class="md-tabs__link">
          
  
  
  Modules

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigazione" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="VitaLink Documentation" class="md-nav__button md-logo" aria-label="VitaLink Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    VitaLink Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/andrearoggeri22/VitaLink" title="Apri repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    VitaLink
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Modules
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="api.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="app.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    App
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="audit.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Audit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="auth.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Auth
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="compile_translations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Compile Translations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="email_utils.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Email Utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Health Platforms
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="health_platforms.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Health Platforms
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Indice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Indice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms" class="md-nav__link">
    <span class="md-ellipsis">
      health_platforms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.health_bp" class="md-nav__link">
    <span class="md-ellipsis">
      health_bp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.vitals_cache" class="md-nav__link">
    <span class="md-ellipsis">
      vitals_cache
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.api_rate_limit" class="md-nav__link">
    <span class="md-ellipsis">
      api_rate_limit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.api_logger" class="md-nav__link">
    <span class="md-ellipsis">
      api_logger
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.api_file_handler" class="md-nav__link">
    <span class="md-ellipsis">
      api_file_handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.formatter" class="md-nav__link">
    <span class="md-ellipsis">
      formatter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.generate_platform_link" class="md-nav__link">
    <span class="md-ellipsis">
      generate_platform_link
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_link_by_uuid" class="md-nav__link">
    <span class="md-ellipsis">
      get_link_by_uuid
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_fitbit_authorization_url" class="md-nav__link">
    <span class="md-ellipsis">
      get_fitbit_authorization_url
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.exchange_fitbit_code_for_token" class="md-nav__link">
    <span class="md-ellipsis">
      exchange_fitbit_code_for_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.refresh_fitbit_token" class="md-nav__link">
    <span class="md-ellipsis">
      refresh_fitbit_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.save_fitbit_tokens" class="md-nav__link">
    <span class="md-ellipsis">
      save_fitbit_tokens
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.ensure_fresh_token" class="md-nav__link">
    <span class="md-ellipsis">
      ensure_fresh_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.check_rate_limit" class="md-nav__link">
    <span class="md-ellipsis">
      check_rate_limit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.increment_api_call_counter" class="md-nav__link">
    <span class="md-ellipsis">
      increment_api_call_counter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_fitbit_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_fitbit_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.extract_nested_value" class="md-nav__link">
    <span class="md-ellipsis">
      extract_nested_value
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_heart_rate_data" class="md-nav__link">
    <span class="md-ellipsis">
      process_heart_rate_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_nested_value_list" class="md-nav__link">
    <span class="md-ellipsis">
      process_nested_value_list
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_nested_value_dict" class="md-nav__link">
    <span class="md-ellipsis">
      process_nested_value_dict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_standard_list" class="md-nav__link">
    <span class="md-ellipsis">
      process_standard_list
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_standard_dict" class="md-nav__link">
    <span class="md-ellipsis">
      process_standard_dict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_fitbit_data" class="md-nav__link">
    <span class="md-ellipsis">
      process_fitbit_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_vitals_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_vitals_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_processed_fitbit_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_processed_fitbit_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.create_link" class="md-nav__link">
    <span class="md-ellipsis">
      create_link
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.connect_platform" class="md-nav__link">
    <span class="md-ellipsis">
      connect_platform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.start_auth" class="md-nav__link">
    <span class="md-ellipsis">
      start_auth
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.oauth_callback" class="md-nav__link">
    <span class="md-ellipsis">
      oauth_callback
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.check_connection" class="md-nav__link">
    <span class="md-ellipsis">
      check_connection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.disconnect_platform" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect_platform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_data
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="health_platforms_config.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Health Platforms Config
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="language.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Language
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="main.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Main
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="migrate.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Migrate
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="models.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="observations.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observations
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reports.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reports
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="utils.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="views.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Views
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Indice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Indice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms" class="md-nav__link">
    <span class="md-ellipsis">
      health_platforms
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.health_bp" class="md-nav__link">
    <span class="md-ellipsis">
      health_bp
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.vitals_cache" class="md-nav__link">
    <span class="md-ellipsis">
      vitals_cache
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.api_rate_limit" class="md-nav__link">
    <span class="md-ellipsis">
      api_rate_limit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.logger" class="md-nav__link">
    <span class="md-ellipsis">
      logger
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.api_logger" class="md-nav__link">
    <span class="md-ellipsis">
      api_logger
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.api_file_handler" class="md-nav__link">
    <span class="md-ellipsis">
      api_file_handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.formatter" class="md-nav__link">
    <span class="md-ellipsis">
      formatter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.generate_platform_link" class="md-nav__link">
    <span class="md-ellipsis">
      generate_platform_link
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_link_by_uuid" class="md-nav__link">
    <span class="md-ellipsis">
      get_link_by_uuid
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_fitbit_authorization_url" class="md-nav__link">
    <span class="md-ellipsis">
      get_fitbit_authorization_url
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.exchange_fitbit_code_for_token" class="md-nav__link">
    <span class="md-ellipsis">
      exchange_fitbit_code_for_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.refresh_fitbit_token" class="md-nav__link">
    <span class="md-ellipsis">
      refresh_fitbit_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.save_fitbit_tokens" class="md-nav__link">
    <span class="md-ellipsis">
      save_fitbit_tokens
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.ensure_fresh_token" class="md-nav__link">
    <span class="md-ellipsis">
      ensure_fresh_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.check_rate_limit" class="md-nav__link">
    <span class="md-ellipsis">
      check_rate_limit
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.increment_api_call_counter" class="md-nav__link">
    <span class="md-ellipsis">
      increment_api_call_counter
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_fitbit_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_fitbit_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.extract_nested_value" class="md-nav__link">
    <span class="md-ellipsis">
      extract_nested_value
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_heart_rate_data" class="md-nav__link">
    <span class="md-ellipsis">
      process_heart_rate_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_nested_value_list" class="md-nav__link">
    <span class="md-ellipsis">
      process_nested_value_list
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_nested_value_dict" class="md-nav__link">
    <span class="md-ellipsis">
      process_nested_value_dict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_standard_list" class="md-nav__link">
    <span class="md-ellipsis">
      process_standard_list
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_standard_dict" class="md-nav__link">
    <span class="md-ellipsis">
      process_standard_dict
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.process_fitbit_data" class="md-nav__link">
    <span class="md-ellipsis">
      process_fitbit_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_vitals_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_vitals_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_processed_fitbit_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_processed_fitbit_data
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.create_link" class="md-nav__link">
    <span class="md-ellipsis">
      create_link
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.connect_platform" class="md-nav__link">
    <span class="md-ellipsis">
      connect_platform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.start_auth" class="md-nav__link">
    <span class="md-ellipsis">
      start_auth
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.oauth_callback" class="md-nav__link">
    <span class="md-ellipsis">
      oauth_callback
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.check_connection" class="md-nav__link">
    <span class="md-ellipsis">
      check_connection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.disconnect_platform" class="md-nav__link">
    <span class="md-ellipsis">
      disconnect_platform
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.health_platforms.get_data" class="md-nav__link">
    <span class="md-ellipsis">
      get_data
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Health Platforms</h1>

<div class="doc doc-object doc-module">



<a id="app.health_platforms"></a>
    <div class="doc doc-contents first">

        <p>Health Platforms Integration Module.</p>
<p>This module provides comprehensive functionality to connect to, authenticate with,
and retrieve data from various health and fitness platforms. It currently supports
Fitbit with extensibility for other platforms like Google Health Connect and Apple Health.</p>
<p>Key features:
1. OAuth2 authentication flows for connecting user accounts to health platforms
2. API clients for retrieving different types of health data (heart rate, steps, etc.)
3. Data processing and normalization to standardize data across platforms
4. Intelligent caching to minimize API calls and respect rate limits
5. Error handling for API failures, token expiration, and invalid requests</p>
<p>The module implements a Blueprint with routes for connecting/disconnecting platforms
and background functionality for data synchronization. It includes proper audit logging
for all operations to maintain a record of data access.</p>









  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="app.health_platforms.health_bp" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">health_bp</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;health&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">=</span><span class="s1">&#39;/health&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#app.health_platforms.health_bp" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Health Platforms Blueprint.</p>
<p>This blueprint manages all routes related to health platform integrations,
including OAuth flows, connection management, and data retrieval.
It provides both web interface endpoints and API endpoints for interacting
with third-party health data sources.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="app.health_platforms.vitals_cache" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vitals_cache</span> <span class="o">=</span> <span class="p">{}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#app.health_platforms.vitals_cache" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Rate limit management for health platform API calls.</p>
<p>This dictionary tracks API usage to ensure the application respects
the rate limits imposed by health platforms (particularly Fitbit).
It implements a sliding window approach to track call frequency and
automatically backs off when approaching limits.</p>


<details class="structure" open>
  <summary>Structure</summary>
  <p>{
    'last_reset': datetime,      # Last time the counter was reset
    'calls': 0,                  # Call counter within current window
    'hourly_limit': 150,         # Hourly call limit (Fitbit rate limit)
    'retry_after': None          # Time when we can resume calls after hitting limit
}</p>
</details>        <p>When the rate limit is reached, subsequent calls are blocked until
the retry_after time, preventing HTTP 429 errors from the API.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="app.health_platforms.api_rate_limit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">api_rate_limit</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;last_reset&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="s1">&#39;calls&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;hourly_limit&#39;</span><span class="p">:</span> <span class="mi">150</span><span class="p">,</span> <span class="s1">&#39;retry_after&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#app.health_platforms.api_rate_limit" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="app.health_platforms.logger" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#app.health_platforms.logger" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Health platforms module logger.</p>
<p>Logger for tracking events related to health platform integrations,
including connection attempts, OAuth flows, API calls, and data synchronization.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="app.health_platforms.api_logger" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">api_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;fitbit_api&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#app.health_platforms.api_logger" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Specialized logger for Fitbit API interactions.</p>
<p>This dedicated logger captures detailed information about all Fitbit API calls,
responses, errors, and rate limit information. It writes to a separate log file
for easier debugging and monitoring of API-specific issues.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="app.health_platforms.api_file_handler" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">api_file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;fitbit_api.log&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#app.health_platforms.api_file_handler" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>File handler for Fitbit API logs.</p>
<p>Writes detailed Fitbit API interaction logs to a dedicated file, separate
from the main application logs for easier troubleshooting of API issues.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="app.health_platforms.formatter" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#app.health_platforms.formatter" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Log formatter for Fitbit API logs.</p>
<p>Defines the format for API log entries, including timestamp, log level,
and the actual message content.</p>

    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.generate_platform_link" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_platform_link</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">doctor</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span></code>

<a href="#app.health_platforms.generate_platform_link" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate a temporary link for a patient to connect to a health platform.</p>
<p>This function creates a unique, time-limited link that can be shared with a patient
to authorize connection to a health platform (e.g., Fitbit). The link contains
a secure token that expires after a set period and can only be used once.</p>
<p>The link is recorded in the database and associated with both the patient and
the doctor who initiated the connection. Old/expired links for the same patient
and platform are invalidated to maintain security.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Patient (app.models.Patient)" href="models.html#app.models.Patient">Patient</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The patient object to connect to the platform</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>doctor</code>
            </td>
            <td>
                  <code><span title="Doctor">Doctor</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The doctor who is initiating the connection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>platform</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="HealthPlatform (app.models.HealthPlatform)" href="models.html#app.models.HealthPlatform">HealthPlatform</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Which health platform to connect to (e.g., FITBIT)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>HealthPlatformLink</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The created link object containing the token and URL</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="SQLAlchemyError">SQLAlchemyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If there's a database issue when creating the link</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="k">def</span><span class="w"> </span><span class="nf">generate_platform_link</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">doctor</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">    Generate a temporary link for a patient to connect to a health platform.</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    This function creates a unique, time-limited link that can be shared with a patient</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">    to authorize connection to a health platform (e.g., Fitbit). The link contains</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    a secure token that expires after a set period and can only be used once.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">    The link is recorded in the database and associated with both the patient and</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">    the doctor who initiated the connection. Old/expired links for the same patient</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    and platform are invalidated to maintain security.</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        patient (Patient): The patient object to connect to the platform</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        doctor (Doctor): The doctor who is initiating the connection</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        platform (HealthPlatform): Which health platform to connect to (e.g., FITBIT)</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        HealthPlatformLink: The created link object containing the token and URL</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        SQLAlchemyError: If there&#39;s a database issue when creating the link</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="c1"># First, invalidate any existing links for this patient and platform</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">existing_links</span> <span class="o">=</span> <span class="n">HealthPlatformLink</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">patient_id</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="n">platform</span><span class="o">=</span><span class="n">platform</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="n">used</span><span class="o">=</span><span class="kc">False</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">existing_links</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">link</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="c1"># Create a new link</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">new_link</span> <span class="o">=</span> <span class="n">HealthPlatformLink</span><span class="p">(</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">patient_id</span><span class="o">=</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="n">doctor_id</span><span class="o">=</span><span class="n">doctor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">platform</span><span class="o">=</span><span class="n">platform</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_link</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="c1"># Log the action</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="n">log_health_link_creation</span><span class="p">(</span><span class="n">doctor</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new_link</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_error</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging platform link creation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">log_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">return</span> <span class="n">new_link</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating platform link: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.get_link_by_uuid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_link_by_uuid</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span></code>

<a href="#app.health_platforms.get_link_by_uuid" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve a health platform link by its UUID.</p>
<p>This function looks up an existing health platform connection link
using its unique identifier. These links are created when a doctor
initiates a connection process for a patient.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>uuid</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The unique identifier of the platform link</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>HealthPlatformLink</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The found link object, or None if not found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>link = get_link_by_uuid("123e4567-e89b-12d3-a456-426614174000")
if link and not link.used:
    # Process valid link</p>
</details>

            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_link_by_uuid</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">    Retrieve a health platform link by its UUID.</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    This function looks up an existing health platform connection link</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">    using its unique identifier. These links are created when a doctor</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">    initiates a connection process for a patient.</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        uuid (str): The unique identifier of the platform link</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        HealthPlatformLink: The found link object, or None if not found</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">    Example:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        link = get_link_by_uuid(&quot;123e4567-e89b-12d3-a456-426614174000&quot;)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        if link and not link.used:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">            # Process valid link</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="k">return</span> <span class="n">HealthPlatformLink</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">uuid</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.get_fitbit_authorization_url" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_fitbit_authorization_url</span><span class="p">(</span><span class="n">link_uuid</span><span class="p">)</span></code>

<a href="#app.health_platforms.get_fitbit_authorization_url" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Generate the Fitbit authorization URL for initiating the OAuth2 flow.</p>
<p>This function builds the URL to Fitbit's authorization endpoint with all
necessary OAuth2 parameters. When a user visits this URL, they will be
prompted to log in to their Fitbit account and authorize the VitaLink
application to access their health data according to the requested scopes.</p>
<p>The function includes:
- Client ID from Fitbit Developer configuration
- Required response_type for authorization code flow
- All needed data scopes (activity, heartrate, etc.)
- Redirect URI for OAuth callback
- State parameter for security (using the link UUID)
- Expiration setting requesting maximum token lifetime</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>link_uuid</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>UUID of the health platform link, used as the state
            parameter to prevent CSRF attacks</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Complete authorization URL to redirect the user to
 This URL points to Fitbit's authorization server</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_fitbit_authorization_url</span><span class="p">(</span><span class="n">link_uuid</span><span class="p">):</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">    Generate the Fitbit authorization URL for initiating the OAuth2 flow.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">    This function builds the URL to Fitbit&#39;s authorization endpoint with all</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">    necessary OAuth2 parameters. When a user visits this URL, they will be</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">    prompted to log in to their Fitbit account and authorize the VitaLink</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">    application to access their health data according to the requested scopes.</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a><span class="sd">    The function includes:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a><span class="sd">    - Client ID from Fitbit Developer configuration</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a><span class="sd">    - Required response_type for authorization code flow</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a><span class="sd">    - All needed data scopes (activity, heartrate, etc.)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a><span class="sd">    - Redirect URI for OAuth callback</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="sd">    - State parameter for security (using the link UUID)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="sd">    - Expiration setting requesting maximum token lifetime</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">        link_uuid (str): UUID of the health platform link, used as the state</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">                        parameter to prevent CSRF attacks</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">        str: Complete authorization URL to redirect the user to</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">             This URL points to Fitbit&#39;s authorization server</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">],</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="s1">&#39;response_type&#39;</span><span class="p">:</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;scope&#39;</span><span class="p">],</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;redirect_uri&#39;</span><span class="p">],</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">link_uuid</span><span class="p">,</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="s1">&#39;expires_in&#39;</span><span class="p">:</span> <span class="mi">31536000</span>  <span class="c1"># 365 days (1 year) - maximum allowed by Fitbit</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>    <span class="p">}</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="n">auth_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;authorize_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="k">return</span> <span class="n">auth_url</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.exchange_fitbit_code_for_token" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">exchange_fitbit_code_for_token</span><span class="p">(</span><span class="n">authorization_code</span><span class="p">)</span></code>

<a href="#app.health_platforms.exchange_fitbit_code_for_token" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Exchange an authorization code for an access token</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>authorization_code</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Authorization code from Fitbit</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token response with access_token, refresh_token, etc. or None if error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="k">def</span><span class="w"> </span><span class="nf">exchange_fitbit_code_for_token</span><span class="p">(</span><span class="n">authorization_code</span><span class="p">):</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a><span class="sd">    Exchange an authorization code for an access token</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="sd">        authorization_code (str): Authorization code from Fitbit</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a><span class="sd">        dict: Token response with access_token, refresh_token, etc. or None if error</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="c1"># Create the Authorization header (Basic auth with client_id:client_secret)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">auth_header</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;client_secret&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Basic </span><span class="si">{</span><span class="n">auth_header</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="p">}</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="s1">&#39;client_id&#39;</span><span class="p">:</span> <span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">],</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;authorization_code&#39;</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">authorization_code</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="s1">&#39;redirect_uri&#39;</span><span class="p">:</span> <span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;redirect_uri&#39;</span><span class="p">]</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="p">}</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;token_url&#39;</span><span class="p">],</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="n">data</span><span class="o">=</span><span class="n">data</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="p">)</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting Fitbit token: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception during token exchange: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.refresh_fitbit_token" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">refresh_fitbit_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">)</span></code>

<a href="#app.health_platforms.refresh_fitbit_token" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Refresh an expired Fitbit access token</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>refresh_token</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Refresh token from previous authorization</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>New token response or None if error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="k">def</span><span class="w"> </span><span class="nf">refresh_fitbit_token</span><span class="p">(</span><span class="n">refresh_token</span><span class="p">):</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">    Refresh an expired Fitbit access token</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">        refresh_token (str): Refresh token from previous authorization</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">        dict: New token response or None if error</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="c1"># Create the Authorization header (Basic auth with client_id:client_secret)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">auth_header</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;client_secret&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Basic </span><span class="si">{</span><span class="n">auth_header</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="p">}</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="s1">&#39;grant_type&#39;</span><span class="p">:</span> <span class="s1">&#39;refresh_token&#39;</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="s1">&#39;refresh_token&#39;</span><span class="p">:</span> <span class="n">refresh_token</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="p">}</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;token_url&#39;</span><span class="p">],</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">data</span><span class="o">=</span><span class="n">data</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error refreshing Fitbit token: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception during token refresh: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.save_fitbit_tokens" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_fitbit_tokens</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">token_response</span><span class="p">)</span></code>

<a href="#app.health_platforms.save_fitbit_tokens" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Save OAuth2 tokens from Fitbit to the patient record.</p>
<p>This function processes the token response received after a successful OAuth2
authentication with Fitbit and stores the relevant token information in the
patient's record. It handles both initial authorization and token refresh flows.</p>
<p>The function stores:
- Access token (for API calls)
- Refresh token (for renewing access when it expires)
- Expiration time (calculated based on expires_in value)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Patient (app.models.Patient)" href="models.html#app.models.Patient">Patient</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The patient object to update with token information</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>token_response</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The OAuth2 token response from Fitbit API</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if tokens were saved successfully, False if an error occurred</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Logs database errors but doesn't propagate them</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="k">def</span><span class="w"> </span><span class="nf">save_fitbit_tokens</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">token_response</span><span class="p">):</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a><span class="sd">    Save OAuth2 tokens from Fitbit to the patient record.</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a><span class="sd">    This function processes the token response received after a successful OAuth2</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a><span class="sd">    authentication with Fitbit and stores the relevant token information in the</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a><span class="sd">    patient&#39;s record. It handles both initial authorization and token refresh flows.</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a><span class="sd">    The function stores:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a><span class="sd">    - Access token (for API calls)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a><span class="sd">    - Refresh token (for renewing access when it expires)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a><span class="sd">    - Expiration time (calculated based on expires_in value)</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a><span class="sd">        patient (Patient): The patient object to update with token information</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a><span class="sd">        token_response (dict): The OAuth2 token response from Fitbit API</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        bool: True if tokens were saved successfully, False if an error occurred</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">        Exception: Logs database errors but doesn&#39;t propagate them</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="c1"># Extract token data</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">access_token</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">refresh_token</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refresh_token&#39;</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="c1"># Default to 1 year if not provided - the maximum possible for Fitbit</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">expires_in</span> <span class="o">=</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expires_in&#39;</span><span class="p">,</span> <span class="mi">31536000</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="c1"># Calculate expiry date</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>        <span class="n">expires_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">expires_in</span><span class="p">)</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="c1"># Update patient record</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">=</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">FITBIT</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">platform_access_token</span> <span class="o">=</span> <span class="n">access_token</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">platform_refresh_token</span> <span class="o">=</span> <span class="n">refresh_token</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="o">=</span> <span class="n">expires_at</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving Fitbit tokens: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.ensure_fresh_token" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ensure_fresh_token</span><span class="p">(</span><span class="n">patient</span><span class="p">)</span></code>

<a href="#app.health_platforms.ensure_fresh_token" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Ensure the patient has a valid (not expired) Fitbit token.</p>
<p>This function checks if the patient's Fitbit access token is still valid
and attempts to refresh it if expired. It handles all aspects of token
management including checking expiration time, using the refresh token
to obtain a new access token, and updating the patient record with new
token information.</p>
<p>A small buffer time (5 minutes) is applied to the expiration to prevent
using tokens that are about to expire during an operation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Patient (app.models.Patient)" href="models.html#app.models.Patient">Patient</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Patient object with stored token information</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Valid access token ready for API use, or None if unable to get one
  (due to disconnected platform, missing tokens, or refresh failure)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="side-effects" open>
  <summary>Side effects</summary>
  <p>Updates the patient's token information in the database if refreshed</p>
</details>

            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="k">def</span><span class="w"> </span><span class="nf">ensure_fresh_token</span><span class="p">(</span><span class="n">patient</span><span class="p">):</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">    Ensure the patient has a valid (not expired) Fitbit token.</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">    This function checks if the patient&#39;s Fitbit access token is still valid</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">    and attempts to refresh it if expired. It handles all aspects of token</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">    management including checking expiration time, using the refresh token</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">    to obtain a new access token, and updating the patient record with new</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">    token information.</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a><span class="sd">    A small buffer time (5 minutes) is applied to the expiration to prevent</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a><span class="sd">    using tokens that are about to expire during an operation.</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a><span class="sd">        patient (Patient): Patient object with stored token information</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="sd">        str: Valid access token ready for API use, or None if unable to get one</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">              (due to disconnected platform, missing tokens, or refresh failure)</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">    Side effects:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">        Updates the patient&#39;s token information in the database if refreshed</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">==</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">FITBIT</span><span class="p">:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Patient is not connected to Fitbit&quot;</span><span class="p">)</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_access_token</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Patient has no Fitbit token data&quot;</span><span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="c1"># Check if token is still valid (with a 5 minute buffer)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="k">return</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_access_token</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="c1"># Token is expired or expiring soon, try to refresh</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_refresh_token</span><span class="p">:</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No refresh token available&quot;</span><span class="p">)</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="c1"># Refresh the token</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="n">token_response</span> <span class="o">=</span> <span class="n">refresh_fitbit_token</span><span class="p">(</span><span class="n">patient</span><span class="o">.</span><span class="n">platform_refresh_token</span><span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="k">if</span> <span class="n">token_response</span><span class="p">:</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="k">if</span> <span class="n">save_fitbit_tokens</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">token_response</span><span class="p">):</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="k">return</span> <span class="n">token_response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;access_token&#39;</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.check_rate_limit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_rate_limit</span><span class="p">()</span></code>

<a href="#app.health_platforms.check_rate_limit" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Check if we have reached the Fitbit API rate limit.</p>
<p>This function implements the rate limiting logic to prevent exceeding
Fitbit's API call limits, which could result in temporary service blocks.
It tracks call frequency in a sliding window approach and enforces
waiting periods when limits are reached.</p>
<p>The function checks:
1. If we're in a forced wait period after hitting the rate limit
2. If the hourly window has elapsed, resetting the counter when needed
3. If we've exceeded the hourly call limit</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if we can make API requests, False if we should wait
  When False is returned, the application should avoid making
  new API calls until the rate limit window resets</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">():</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">    Check if we have reached the Fitbit API rate limit.</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">    This function implements the rate limiting logic to prevent exceeding</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">    Fitbit&#39;s API call limits, which could result in temporary service blocks.</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">    It tracks call frequency in a sliding window approach and enforces</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">    waiting periods when limits are reached.</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="sd">    The function checks:</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">    1. If we&#39;re in a forced wait period after hitting the rate limit</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">    2. If the hourly window has elapsed, resetting the counter when needed</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">    3. If we&#39;ve exceeded the hourly call limit</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a><span class="sd">        bool: True if we can make API requests, False if we should wait</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a><span class="sd">              When False is returned, the application should avoid making</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a><span class="sd">              new API calls until the rate limit window resets</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="k">global</span> <span class="n">api_rate_limit</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="c1"># If there&#39;s a retry_after set and it hasn&#39;t passed yet, block requests</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="k">if</span> <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="n">wait_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limit active, wait </span><span class="si">{</span><span class="n">wait_seconds</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>    <span class="c1"># If an hour has passed since the last reset, reset the counter</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;last_reset&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">3600</span><span class="p">:</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;last_reset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;calls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Rate limit counter reset after 1 hour.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="c1"># Check if we&#39;ve exceeded the hourly limit</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>    <span class="k">if</span> <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;calls&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;hourly_limit&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;last_reset&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limit reached (</span><span class="si">{</span><span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;calls&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> calls). &quot;</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                           <span class="sa">f</span><span class="s2">&quot;Try again after </span><span class="si">{</span><span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.increment_api_call_counter" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">increment_api_call_counter</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#app.health_platforms.increment_api_call_counter" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Increment the API call counter and handle any rate limits.</p>
<p>This function updates the API call tracking system after each API request
and processes any rate limit information returned from the Fitbit API.
It is essential for maintaining compliance with Fitbit's API usage policies
and preventing API lockout due to excessive calls.</p>
<p>The function handles various rate limiting scenarios:
1. Incrementing the call counter for normal tracking
2. Detecting 429 (Too Many Requests) responses
3. Processing the Retry-After header value to establish waiting periods</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>response</code>
            </td>
            <td>
                  <code><span title="Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The API response object to check for
rate limit headers. If None, only increments the counter without
checking for rate limiting headers.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="side-effects" open>
  <summary>Side effects</summary>
  <p>Updates the global api_rate_limit dictionary with new counts and
potentially sets the retry_after timestamp when rate limits are hit.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-489" name="__codelineno-0-489"></a><span class="k">def</span><span class="w"> </span><span class="nf">increment_api_call_counter</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a><span class="sd">    Increment the API call counter and handle any rate limits.</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a><span class="sd">    This function updates the API call tracking system after each API request</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a><span class="sd">    and processes any rate limit information returned from the Fitbit API.</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a><span class="sd">    It is essential for maintaining compliance with Fitbit&#39;s API usage policies</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a><span class="sd">    and preventing API lockout due to excessive calls.</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="sd">    The function handles various rate limiting scenarios:</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="sd">    1. Incrementing the call counter for normal tracking</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a><span class="sd">    2. Detecting 429 (Too Many Requests) responses</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a><span class="sd">    3. Processing the Retry-After header value to establish waiting periods</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a><span class="sd">        response (Response, optional): The API response object to check for</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a><span class="sd">            rate limit headers. If None, only increments the counter without</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a><span class="sd">            checking for rate limiting headers.</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a><span class="sd">    Side effects:</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="sd">        Updates the global api_rate_limit dictionary with new counts and</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">        potentially sets the retry_after timestamp when rate limits are hit.</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>    <span class="k">global</span> <span class="n">api_rate_limit</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;calls&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>    <span class="c1"># If the response contains rate limit headers, update our limits</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>    <span class="k">if</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>        <span class="c1"># Get the Retry-After value if present</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>        <span class="n">retry_after</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Retry-After&#39;</span><span class="p">)</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>        <span class="k">if</span> <span class="n">retry_after</span><span class="p">:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                <span class="n">seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">retry_after</span><span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">seconds</span><span class="p">)</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limit reached. Retry-After: </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>                <span class="c1"># If it&#39;s not an integer, assume it&#39;s an RFC1123 date</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Rate limit reached. Wait for 1 hour.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>            <span class="c1"># If there&#39;s no Retry-After, wait 1 hour for safety</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="n">api_rate_limit</span><span class="p">[</span><span class="s1">&#39;retry_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Rate limit reached. Wait for 1 hour.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.get_fitbit_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_fitbit_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#app.health_platforms.get_fitbit_data" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve raw data from Fitbit API for the specified data type.</p>
<p>This function handles all aspects of communicating with Fitbit's API
to retrieve health data, including token management, rate limit checking,
proper URL formatting, and error handling. It supports various Fitbit
data types as defined in FITBIT_ENDPOINTS.</p>
<p>This is a lower-level function that returns the raw API response. For
processed and formatted data suitable for the application, use 
get_processed_fitbit_data() instead.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Patient (app.models.Patient)" href="models.html#app.models.Patient">Patient</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Patient object with Fitbit connection information</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of data to retrieve (heart_rate, steps, sleep, etc.)
             Must be one of the keys in FITBIT_ENDPOINTS</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_date</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date in YYYY-MM-DD format
                       Defaults to current date if not provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_date</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End date in YYYY-MM-DD format
                     Defaults to current date if not provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Raw data from Fitbit API or None if any error occurs
  (authentication failure, rate limit, invalid data type, etc.)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function respects Fitbit's rate limits and may refuse to make
a request if the rate limit has been reached. In such cases, None
is returned and the caller should wait before retrying.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_fitbit_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="sd">    Retrieve raw data from Fitbit API for the specified data type.</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">    This function handles all aspects of communicating with Fitbit&#39;s API</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">    to retrieve health data, including token management, rate limit checking,</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">    proper URL formatting, and error handling. It supports various Fitbit</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">    data types as defined in FITBIT_ENDPOINTS.</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">    This is a lower-level function that returns the raw API response. For</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">    processed and formatted data suitable for the application, use </span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">    get_processed_fitbit_data() instead.</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">        patient (Patient): Patient object with Fitbit connection information</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">        data_type (str): Type of data to retrieve (heart_rate, steps, sleep, etc.)</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">                         Must be one of the keys in FITBIT_ENDPOINTS</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">        start_date (str, optional): Start date in YYYY-MM-DD format</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">                                   Defaults to current date if not provided</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">        end_date (str, optional): End date in YYYY-MM-DD format</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">                                 Defaults to current date if not provided</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">        dict: Raw data from Fitbit API or None if any error occurs</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">              (authentication failure, rate limit, invalid data type, etc.)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a><span class="sd">        This function respects Fitbit&#39;s rate limits and may refuse to make</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a><span class="sd">        a request if the rate limit has been reached. In such cases, None</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a><span class="sd">        is returned and the caller should wait before retrying.</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>    <span class="c1"># Check if we have reached the rate limit</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_rate_limit</span><span class="p">():</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rate limit active, request blocked: </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> for patient </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>    <span class="k">if</span> <span class="n">data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FITBIT_ENDPOINTS</span><span class="p">:</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported Fitbit data type: </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>    <span class="n">access_token</span> <span class="o">=</span> <span class="n">ensure_fresh_token</span><span class="p">(</span><span class="n">patient</span><span class="p">)</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">access_token</span><span class="p">:</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access token not available for patient </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>    <span class="n">endpoint_config</span> <span class="o">=</span> <span class="n">FITBIT_ENDPOINTS</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>    <span class="c1"># Generate a unique log request ID to track this specific request</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>    <span class="c1"># Build the appropriate endpoint based on dates and data type</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>    <span class="k">if</span> <span class="n">start_date</span> <span class="ow">and</span> <span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>        <span class="c1"># Calculate the difference in days between the dates to check if it&#39;s within Fitbit&#39;s limits</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>            <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>            <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>            <span class="n">days_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_dt</span> <span class="o">-</span> <span class="n">start_dt</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>            <span class="c1"># Check if the range exceeds the maximum number of days for this data type</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>            <span class="n">max_range</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_range_days&#39;</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>            <span class="k">if</span> <span class="n">days_diff</span> <span class="o">&gt;</span> <span class="n">max_range</span><span class="p">:</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Range of </span><span class="si">{</span><span class="n">days_diff</span><span class="si">}</span><span class="s2"> days exceeds the limit of </span><span class="si">{</span><span class="n">max_range</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>                                 <span class="sa">f</span><span class="s2">&quot;Limiting to </span><span class="si">{</span><span class="n">max_range</span><span class="si">}</span><span class="s2"> days from </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>                <span class="c1"># Limit the range to the maximum allowed, starting from the end date</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>                <span class="n">start_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">max_range</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Modified range: </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error in date format: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>        <span class="c1"># Use the specific range endpoint for this data type</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>        <span class="k">if</span> <span class="s1">&#39;range_endpoint&#39;</span> <span class="ow">in</span> <span class="n">endpoint_config</span><span class="p">:</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>            <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="p">[</span><span class="s1">&#39;range_endpoint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Using range endpoint for </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>            <span class="c1"># Fallback to the generic format if no range_endpoint is specified</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>            <span class="n">base</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_endpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>            <span class="n">endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">.json&quot;</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Using generic endpoint for </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>        <span class="c1"># If no dates are provided, use the default endpoint</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">]</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Using default endpoint for </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">access_token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>        <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;it_IT&#39;</span>  <span class="c1"># Request data in Italian format</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>    <span class="p">}</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Fitbit API call: </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>        <span class="c1"># Make the API call</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;api_base_url&#39;</span><span class="p">]</span><span class="si">}{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>        <span class="p">)</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>          <span class="c1"># Increment API call counter</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>        <span class="n">increment_api_call_counter</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Data successfully received for </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>            <span class="c1"># Detailed log for debugging (only in debug mode)</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>            <span class="k">if</span> <span class="n">api_logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>                <span class="n">truncated_data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)[:</span><span class="mi">1000</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Response: </span><span class="si">{</span><span class="n">truncated_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>            <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">429</span><span class="p">:</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>            <span class="c1"># Rate limit reached</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>            <span class="n">retry_after</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Retry-After&#39;</span><span class="p">,</span> <span class="s1">&#39;3600&#39;</span><span class="p">)</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Rate limit reached. Retry-After: </span><span class="si">{</span><span class="n">retry_after</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error retrieving data: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Exception during data retrieval: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.extract_nested_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_nested_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code>

<a href="#app.health_platforms.extract_nested_value" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Extract a nested value from an object based on a path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>obj</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dictionary to extract the value from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of keys forming the path to the value</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value at the specified path, or None if not found</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-657" name="__codelineno-0-657"></a><span class="k">def</span><span class="w"> </span><span class="nf">extract_nested_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a><span class="sd">    Extract a nested value from an object based on a path.</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a><span class="sd">        obj (dict): The dictionary to extract the value from</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a><span class="sd">        path (list): List of keys forming the path to the value</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a><span class="sd">        The value at the specified path, or None if not found</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a>    <span class="n">key</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a>    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a>        <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a>        <span class="k">return</span> <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a>    <span class="k">return</span> <span class="n">extract_nested_value</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.process_heart_rate_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_heart_rate_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span></code>

<a href="#app.health_platforms.process_heart_rate_data" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process heart rate data from Fitbit API into standardized format.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Raw heart rate data from Fitbit API</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The unit for heart rate values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>request_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request ID for logging</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed heart rate data in standardized format</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-681" name="__codelineno-0-681"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_heart_rate_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a><span class="sd">    Process heart rate data from Fitbit API into standardized format.</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a><span class="sd">        data (dict): Raw heart rate data from Fitbit API</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a><span class="sd">        unit (str): The unit for heart rate values</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a><span class="sd">        request_id (str): Request ID for logging</span>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a><span class="sd">        list: Processed heart rate data in standardized format</span>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>    <span class="n">heart_results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>    <span class="k">if</span> <span class="s1">&#39;activities-heart&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>    <span class="k">for</span> <span class="n">heart_data</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;activities-heart&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="k">if</span> <span class="s1">&#39;dateTime&#39;</span> <span class="ow">in</span> <span class="n">heart_data</span> <span class="ow">and</span> <span class="s1">&#39;value&#39;</span> <span class="ow">in</span> <span class="n">heart_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heart_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">heart_data</span><span class="p">[</span><span class="s1">&#39;dateTime&#39;</span><span class="p">]</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>            <span class="n">heart_value</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>            <span class="n">value_type</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a>            <span class="c1"># First check if there&#39;s a resting heart rate value</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>            <span class="k">if</span> <span class="s1">&#39;restingHeartRate&#39;</span> <span class="ow">in</span> <span class="n">heart_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a>                <span class="n">heart_value</span> <span class="o">=</span> <span class="n">heart_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;restingHeartRate&#39;</span><span class="p">]</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a>                <span class="n">value_type</span> <span class="o">=</span> <span class="s1">&#39;resting&#39;</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Found resting heart rate value: </span><span class="si">{</span><span class="n">heart_value</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a>            <span class="c1"># If not, calculate an average from heart rate zones</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a>            <span class="k">elif</span> <span class="s1">&#39;heartRateZones&#39;</span> <span class="ow">in</span> <span class="n">heart_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">heart_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;heartRateZones&#39;</span><span class="p">]:</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a>                <span class="n">zones</span> <span class="o">=</span> <span class="n">heart_data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;heartRateZones&#39;</span><span class="p">]</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>                <span class="n">zone_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a>                <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span> <span class="n">zones</span><span class="p">:</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a>                    <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="n">zone</span> <span class="ow">and</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="n">zone</span><span class="p">:</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>                        <span class="c1"># Calculate the average of each zone</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>                        <span class="n">zone_avg</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">zone</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>                        <span class="n">zone_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zone_avg</span><span class="p">)</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>                <span class="k">if</span> <span class="n">zone_values</span><span class="p">:</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>                    <span class="n">heart_value</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">zone_values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">zone_values</span><span class="p">)</span>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>                    <span class="n">value_type</span> <span class="o">=</span> <span class="s1">&#39;zone_avg&#39;</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>                    <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Calculated average value from zones: </span><span class="si">{</span><span class="n">heart_value</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>            <span class="k">if</span> <span class="n">heart_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>                <span class="n">heart_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>                    <span class="s1">&#39;recorded_at&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">heart_value</span><span class="p">),</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>                    <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">value_type</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>                <span class="p">})</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">heart_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> heart rate values&quot;</span><span class="p">)</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>    <span class="k">return</span> <span class="n">heart_results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.process_nested_value_list" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_nested_value_list</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_path</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span></code>

<a href="#app.health_platforms.process_nested_value_list" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process a list of data items with nested value paths.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_list</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of data items to process</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timestamp_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key to extract timestamp from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value_path</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the nested value</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unit for the values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform</code>
            </td>
            <td>
                  <code><span title="callable">callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to transform values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>request_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request ID for logging</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed data items</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_nested_value_list</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_path</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a><span class="sd">    Process a list of data items with nested value paths.</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="sd">        data_list (list): List of data items to process</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><span class="sd">        timestamp_key (str): Key to extract timestamp from</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a><span class="sd">        value_path (list): Path to the nested value</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><span class="sd">        unit (str): Unit for the values</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a><span class="sd">        transform (callable): Function to transform values</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="sd">        request_id (str): Request ID for logging</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a><span class="sd">        list: Processed data items</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>        <span class="k">if</span> <span class="n">timestamp_key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>                <span class="n">nested_value</span> <span class="o">=</span> <span class="n">extract_nested_value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">value_path</span><span class="p">)</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>                <span class="k">if</span> <span class="n">nested_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nested_value</span><span class="p">)</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">timestamp_key</span><span class="p">]</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>                    <span class="c1"># Apply transformations</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>                    <span class="n">value</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>                        <span class="s1">&#39;recorded_at&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>                        <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>                    <span class="p">})</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a>            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error during value processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.process_nested_value_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_nested_value_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_path</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span></code>

<a href="#app.health_platforms.process_nested_value_dict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process a dictionary with nested value paths.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary to process</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timestamp_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key to extract timestamp from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value_path</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the nested value</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unit for the values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform</code>
            </td>
            <td>
                  <code><span title="callable">callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to transform values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>request_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request ID for logging</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed data items</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_nested_value_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_path</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a><span class="sd">    Process a dictionary with nested value paths.</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a><span class="sd">        data_dict (dict): Dictionary to process</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a><span class="sd">        timestamp_key (str): Key to extract timestamp from</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a><span class="sd">        value_path (list): Path to the nested value</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a><span class="sd">        unit (str): Unit for the values</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a><span class="sd">        transform (callable): Function to transform values</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a><span class="sd">        request_id (str): Request ID for logging</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a><span class="sd">        list: Processed data items</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>    <span class="k">if</span> <span class="n">timestamp_key</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>            <span class="n">nested_value</span> <span class="o">=</span> <span class="n">extract_nested_value</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">value_path</span><span class="p">)</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>            <span class="k">if</span> <span class="n">nested_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nested_value</span><span class="p">)</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">timestamp_key</span><span class="p">]</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>                <span class="c1"># Apply transformations</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>                    <span class="s1">&#39;recorded_at&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>                    <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>                <span class="p">})</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error during value processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.process_standard_list" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_standard_list</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_key</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span></code>

<a href="#app.health_platforms.process_standard_list" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process a list of data items with standard key-value structure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_list</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of data items to process</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timestamp_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key to extract timestamp from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key to extract value from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unit for the values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform</code>
            </td>
            <td>
                  <code><span title="callable">callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to transform values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>request_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request ID for logging</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed data items</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-817" name="__codelineno-0-817"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_standard_list</span><span class="p">(</span><span class="n">data_list</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_key</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a><span class="sd">    Process a list of data items with standard key-value structure.</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a><span class="sd">        data_list (list): List of data items to process</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a><span class="sd">        timestamp_key (str): Key to extract timestamp from</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a><span class="sd">        value_key (str): Key to extract value from</span>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a><span class="sd">        unit (str): Unit for the values</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a><span class="sd">        transform (callable): Function to transform values</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a><span class="sd">        request_id (str): Request ID for logging</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a><span class="sd">        list: Processed data items</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>        <span class="k">if</span> <span class="n">value_key</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">timestamp_key</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">value_key</span><span class="p">])</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="n">timestamp_key</span><span class="p">]</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>                <span class="c1"># Apply transformations</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>                <span class="n">value</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>                    <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>                    <span class="s1">&#39;recorded_at&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>                    <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>                <span class="p">})</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error in value processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.process_standard_dict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_standard_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_key</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span></code>

<a href="#app.health_platforms.process_standard_dict" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process a dictionary with standard key-value structure.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary to process</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timestamp_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key to extract timestamp from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Key to extract value from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>unit</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unit for the values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transform</code>
            </td>
            <td>
                  <code><span title="callable">callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function to transform values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>request_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Request ID for logging</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed data items</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-855" name="__codelineno-0-855"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_standard_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_key</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a><span class="sd">    Process a dictionary with standard key-value structure.</span>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a><span class="sd">        data_dict (dict): Dictionary to process</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a><span class="sd">        timestamp_key (str): Key to extract timestamp from</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a><span class="sd">        value_key (str): Key to extract value from</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a><span class="sd">        unit (str): Unit for the values</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a><span class="sd">        transform (callable): Function to transform values</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a><span class="sd">        request_id (str): Request ID for logging</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a><span class="sd">        list: Processed data items</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a>    <span class="k">if</span> <span class="n">value_key</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="ow">and</span> <span class="n">timestamp_key</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">value_key</span><span class="p">])</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">timestamp_key</span><span class="p">]</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>            <span class="c1"># Apply transformations</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>            <span class="n">value</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>                <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>                <span class="s1">&#39;recorded_at&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>            <span class="p">})</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error in value processing: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.process_fitbit_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process_fitbit_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span></code>

<a href="#app.health_platforms.process_fitbit_data" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Process raw Fitbit API data into a standardized format for the application.</p>
<p>This function transforms the varied response formats from different Fitbit API
endpoints into a consistent structure that can be used throughout the application.
It handles the intricacies of each data type according to configurations in
FITBIT_ENDPOINTS, including proper key extraction, value transformation,
and unit standardization.</p>
<p>Data processing includes:
- Navigating the nested JSON structure of Fitbit responses
- Extracting timestamps and converting to ISO 8601 format
- Applying value transformations (e.g., unit conversions)
- Adding appropriate measurement units</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Raw data from Fitbit API as returned by get_fitbit_data()</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of data being processed (must match a key in FITBIT_ENDPOINTS)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed data in standardized format:
  [{'timestamp': ISO8601, 'value': 123, 'unit': 'xyz'}, ...]
  Returns empty list if data is None, empty, or data_type is unsupported</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>Each data point includes:
- timestamp: ISO 8601 formatted time when the measurement was taken
- value: The numerical value of the measurement (may be transformed from raw value)
- unit: The unit of measurement (e.g., 'bpm' for heart rate)</p>
</details>

            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span>
<span class="normal"><a href="#__codelineno-0-935">935</a></span>
<span class="normal"><a href="#__codelineno-0-936">936</a></span>
<span class="normal"><a href="#__codelineno-0-937">937</a></span>
<span class="normal"><a href="#__codelineno-0-938">938</a></span>
<span class="normal"><a href="#__codelineno-0-939">939</a></span>
<span class="normal"><a href="#__codelineno-0-940">940</a></span>
<span class="normal"><a href="#__codelineno-0-941">941</a></span>
<span class="normal"><a href="#__codelineno-0-942">942</a></span>
<span class="normal"><a href="#__codelineno-0-943">943</a></span>
<span class="normal"><a href="#__codelineno-0-944">944</a></span>
<span class="normal"><a href="#__codelineno-0-945">945</a></span>
<span class="normal"><a href="#__codelineno-0-946">946</a></span>
<span class="normal"><a href="#__codelineno-0-947">947</a></span>
<span class="normal"><a href="#__codelineno-0-948">948</a></span>
<span class="normal"><a href="#__codelineno-0-949">949</a></span>
<span class="normal"><a href="#__codelineno-0-950">950</a></span>
<span class="normal"><a href="#__codelineno-0-951">951</a></span>
<span class="normal"><a href="#__codelineno-0-952">952</a></span>
<span class="normal"><a href="#__codelineno-0-953">953</a></span>
<span class="normal"><a href="#__codelineno-0-954">954</a></span>
<span class="normal"><a href="#__codelineno-0-955">955</a></span>
<span class="normal"><a href="#__codelineno-0-956">956</a></span>
<span class="normal"><a href="#__codelineno-0-957">957</a></span>
<span class="normal"><a href="#__codelineno-0-958">958</a></span>
<span class="normal"><a href="#__codelineno-0-959">959</a></span>
<span class="normal"><a href="#__codelineno-0-960">960</a></span>
<span class="normal"><a href="#__codelineno-0-961">961</a></span>
<span class="normal"><a href="#__codelineno-0-962">962</a></span>
<span class="normal"><a href="#__codelineno-0-963">963</a></span>
<span class="normal"><a href="#__codelineno-0-964">964</a></span>
<span class="normal"><a href="#__codelineno-0-965">965</a></span>
<span class="normal"><a href="#__codelineno-0-966">966</a></span>
<span class="normal"><a href="#__codelineno-0-967">967</a></span>
<span class="normal"><a href="#__codelineno-0-968">968</a></span>
<span class="normal"><a href="#__codelineno-0-969">969</a></span>
<span class="normal"><a href="#__codelineno-0-970">970</a></span>
<span class="normal"><a href="#__codelineno-0-971">971</a></span>
<span class="normal"><a href="#__codelineno-0-972">972</a></span>
<span class="normal"><a href="#__codelineno-0-973">973</a></span>
<span class="normal"><a href="#__codelineno-0-974">974</a></span>
<span class="normal"><a href="#__codelineno-0-975">975</a></span>
<span class="normal"><a href="#__codelineno-0-976">976</a></span>
<span class="normal"><a href="#__codelineno-0-977">977</a></span>
<span class="normal"><a href="#__codelineno-0-978">978</a></span>
<span class="normal"><a href="#__codelineno-0-979">979</a></span>
<span class="normal"><a href="#__codelineno-0-980">980</a></span>
<span class="normal"><a href="#__codelineno-0-981">981</a></span>
<span class="normal"><a href="#__codelineno-0-982">982</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-892" name="__codelineno-0-892"></a><span class="k">def</span><span class="w"> </span><span class="nf">process_fitbit_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">):</span>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a><span class="sd">    Process raw Fitbit API data into a standardized format for the application.</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a><span class="sd">    This function transforms the varied response formats from different Fitbit API</span>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a><span class="sd">    endpoints into a consistent structure that can be used throughout the application.</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a><span class="sd">    It handles the intricacies of each data type according to configurations in</span>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a><span class="sd">    FITBIT_ENDPOINTS, including proper key extraction, value transformation,</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a><span class="sd">    and unit standardization.</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a><span class="sd">    Data processing includes:</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a><span class="sd">    - Navigating the nested JSON structure of Fitbit responses</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a><span class="sd">    - Extracting timestamps and converting to ISO 8601 format</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a><span class="sd">    - Applying value transformations (e.g., unit conversions)</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a><span class="sd">    - Adding appropriate measurement units</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a><span class="sd">        data (dict): Raw data from Fitbit API as returned by get_fitbit_data()</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a><span class="sd">        data_type (str): Type of data being processed (must match a key in FITBIT_ENDPOINTS)</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a><span class="sd">        list: Processed data in standardized format:</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a><span class="sd">              [{&#39;timestamp&#39;: ISO8601, &#39;value&#39;: 123, &#39;unit&#39;: &#39;xyz&#39;}, ...]</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a><span class="sd">              Returns empty list if data is None, empty, or data_type is unsupported</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a><span class="sd">        Each data point includes:</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a><span class="sd">        - timestamp: ISO 8601 formatted time when the measurement was taken</span>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a><span class="sd">        - value: The numerical value of the measurement (may be transformed from raw value)</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a><span class="sd">        - unit: The unit of measurement (e.g., &#39;bpm&#39; for heart rate)</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>  <span class="c1"># ID for log tracking</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FITBIT_ENDPOINTS</span><span class="p">:</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] No data for processing or unsupported data type: </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>    <span class="n">endpoint_config</span> <span class="o">=</span> <span class="n">FITBIT_ENDPOINTS</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>    <span class="n">response_key</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="p">[</span><span class="s1">&#39;response_key&#39;</span><span class="p">]</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>    <span class="n">value_key</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="p">[</span><span class="s1">&#39;value_key&#39;</span><span class="p">]</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>    <span class="n">timestamp_key</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="p">[</span><span class="s1">&#39;timestamp_key&#39;</span><span class="p">]</span>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>    <span class="n">unit</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>    <span class="n">transform</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value_transform&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>  <span class="c1"># Default identity function</span>
<a id="__codelineno-0-935" name="__codelineno-0-935"></a>
<a id="__codelineno-0-936" name="__codelineno-0-936"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Processing data </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">, response with key </span><span class="si">{</span><span class="n">response_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a>    <span class="c1"># Special handling for heart rate</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a>    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;heart_rate&#39;</span><span class="p">:</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>        <span class="n">heart_results</span> <span class="o">=</span> <span class="n">process_heart_rate_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a>        <span class="k">if</span> <span class="n">heart_results</span><span class="p">:</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a>            <span class="k">return</span> <span class="n">heart_results</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a>    <span class="c1"># Standard processing</span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a>    <span class="c1"># Extract data from response based on response key</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a>    <span class="k">if</span> <span class="n">response_key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a>        <span class="n">current_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">response_key</span><span class="p">]</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Response key </span><span class="si">{</span><span class="n">response_key</span><span class="si">}</span><span class="s2"> not found in data&quot;</span><span class="p">)</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>    <span class="c1"># Handling of nested values (e.g., value.restingHeartRate, value.avg)</span>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a>    <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">value_key</span><span class="p">:</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a>        <span class="n">value_path</span> <span class="o">=</span> <span class="n">value_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>            <span class="c1"># Process data in list format</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">process_nested_value_list</span><span class="p">(</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>                <span class="n">current_data</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_path</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>            <span class="p">)</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>            <span class="c1"># Process data in dict format</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">process_nested_value_dict</span><span class="p">(</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>                <span class="n">current_data</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_path</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>            <span class="p">)</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>        <span class="c1"># Standard key-value processing</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>            <span class="c1"># Process list format</span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">process_standard_list</span><span class="p">(</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>                <span class="n">current_data</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_key</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>            <span class="p">)</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>            <span class="c1"># Process single dict format</span>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">process_standard_dict</span><span class="p">(</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>                <span class="n">current_data</span><span class="p">,</span> <span class="n">timestamp_key</span><span class="p">,</span> <span class="n">value_key</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">request_id</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>            <span class="p">)</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Processed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results for </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.get_vitals_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_vitals_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache_duration</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span></code>

<a href="#app.health_platforms.get_vitals_data" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get vital sign data for a patient from their connected health platform.</p>
<p>This is the main high-level function used throughout the application to retrieve 
patient health data from connected platforms. It handles platform selection,
caching to minimize API calls, error recovery, and returns data in a consistent
format regardless of the source platform.</p>
<p>Features:
- Intelligent caching with configurable duration
- Automatic platform selection based on patient's connected services
- Consistent data format across all vital sign types and platforms
- Proper error handling and logging</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Patient (app.models.Patient)" href="models.html#app.models.Patient">Patient</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Patient object with connection information</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of data to retrieve (heart_rate, steps, etc.)
            Can be either a string or VitalSignType enum value</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_date</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date in YYYY-MM-DD format
                       Defaults to current date if not provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_date</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End date in YYYY-MM-DD format
                     Defaults to current date if not provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache_duration</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How long to keep data in cache (seconds)
                           Defaults to 300 seconds (5 minutes)</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed data in standardized format:
  [{'timestamp': ISO8601, 'value': 123, 'unit': 'xyz'}, ...]
  Returns empty list if data retrieval fails or no data available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>This function is the preferred way to access health data throughout
the application, as it abstracts away the complexities of different
health platforms and provides consistent caching.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span>
<span class="normal"><a href="#__codelineno-0-1042">1042</a></span>
<span class="normal"><a href="#__codelineno-0-1043">1043</a></span>
<span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-984" name="__codelineno-0-984"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_vitals_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache_duration</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a><span class="sd">    Get vital sign data for a patient from their connected health platform.</span>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a><span class="sd">    This is the main high-level function used throughout the application to retrieve </span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a><span class="sd">    patient health data from connected platforms. It handles platform selection,</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a><span class="sd">    caching to minimize API calls, error recovery, and returns data in a consistent</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a><span class="sd">    format regardless of the source platform.</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a><span class="sd">    Features:</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a><span class="sd">    - Intelligent caching with configurable duration</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a><span class="sd">    - Automatic platform selection based on patient&#39;s connected services</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a><span class="sd">    - Consistent data format across all vital sign types and platforms</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a><span class="sd">    - Proper error handling and logging</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a><span class="sd">        patient (Patient): Patient object with connection information</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a><span class="sd">        data_type (str): Type of data to retrieve (heart_rate, steps, etc.)</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a><span class="sd">                        Can be either a string or VitalSignType enum value</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a><span class="sd">        start_date (str, optional): Start date in YYYY-MM-DD format</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a><span class="sd">                                   Defaults to current date if not provided</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a><span class="sd">        end_date (str, optional): End date in YYYY-MM-DD format</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a><span class="sd">                                 Defaults to current date if not provided</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a><span class="sd">        cache_duration (int, optional): How long to keep data in cache (seconds)</span>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a><span class="sd">                                       Defaults to 300 seconds (5 minutes)</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a><span class="sd">        list: Processed data in standardized format:</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a><span class="sd">              [{&#39;timestamp&#39;: ISO8601, &#39;value&#39;: 123, &#39;unit&#39;: &#39;xyz&#39;}, ...]</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a><span class="sd">              Returns empty list if data retrieval fails or no data available</span>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a><span class="sd">    Note:</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a><span class="sd">        This function is the preferred way to access health data throughout</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a><span class="sd">        the application, as it abstracts away the complexities of different</span>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a><span class="sd">        health platforms and provides consistent caching.</span>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a>    <span class="c1"># Generate a unique ID for this request</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a>    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>    <span class="c1"># Normalize the data type (convert to lowercase if it&#39;s a string)</span>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a>        <span class="n">normalized_data_type</span> <span class="o">=</span> <span class="n">data_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a>        <span class="n">normalized_data_type</span> <span class="o">=</span> <span class="n">data_type</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>    <span class="c1"># Set default dates if not provided</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] End date not provided, using today: </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">start_date</span><span class="p">:</span>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a>        <span class="c1"># Default: 7 days before end date</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>        <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">end_dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Start date not provided, using 7 days before: </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a>    <span class="c1"># Check if we have cached data for this request</span>
<a id="__codelineno-0-1042" name="__codelineno-0-1042"></a>    <span class="n">cache_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">normalized_data_type</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1043" name="__codelineno-0-1043"></a>    <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="n">vitals_cache</span><span class="p">:</span>
<a id="__codelineno-0-1044" name="__codelineno-0-1044"></a>        <span class="c1"># Check if the cache is still valid</span>
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a>        <span class="n">cache_entry</span> <span class="o">=</span> <span class="n">vitals_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a>        <span class="n">cache_time</span> <span class="o">=</span> <span class="n">cache_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache_time&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a>        <span class="k">if</span> <span class="n">cache_time</span><span class="p">:</span>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a>            <span class="n">cache_age</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">cache_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a>            <span class="c1"># If the cache is still valid, use the stored data</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a>            <span class="k">if</span> <span class="n">cache_age</span> <span class="o">&lt;</span> <span class="n">cache_duration</span><span class="p">:</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Using data from cache for </span><span class="si">{</span><span class="n">normalized_data_type</span><span class="si">}</span><span class="s2">, age: </span><span class="si">{</span><span class="n">cache_age</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a>                <span class="k">return</span> <span class="n">cache_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Cache expired for </span><span class="si">{</span><span class="n">normalized_data_type</span><span class="si">}</span><span class="s2">, age: </span><span class="si">{</span><span class="n">cache_age</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a>    <span class="c1"># No valid cache, need to get data from the platform</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a>    <span class="c1"># Check which platform the patient is connected to</span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="p">:</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Patient </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> not connected to any platform&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># To measure execution time</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a>        <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">==</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">FITBIT</span><span class="p">:</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Requesting Fitbit data: </span><span class="si">{</span><span class="n">normalized_data_type</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">get_processed_fitbit_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">normalized_data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a>        <span class="k">elif</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">==</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">GOOGLE_HEALTH_CONNECT</span><span class="p">:</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a>            <span class="c1"># Placeholder for Google Fit implementation</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Google Fit integration not yet implemented&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a>        <span class="k">elif</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">==</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">APPLE_HEALTH</span><span class="p">:</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a>            <span class="c1"># Placeholder for Apple Health implementation</span>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Apple Health integration not yet implemented&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Unsupported platform: </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a>        <span class="c1"># Calculate statistics on the data</span>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a>        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a>            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a>            <span class="s2">&quot;execution_time&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>        <span class="p">}</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>            <span class="c1"># Calculate min, max, avg only if we have data</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a>                <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a>                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a>                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a>                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;avg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a>                    <span class="c1"># Get the unit of measure from the first element</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a>                    <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">stats_error</span><span class="p">:</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error calculating statistics: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">stats_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a>        <span class="c1"># Cache the data with statistics</span>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a>        <span class="n">vitals_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a>            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a>            <span class="s1">&#39;cache_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a>            <span class="s1">&#39;statistics&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="p">,</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a>            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>        <span class="p">}</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> data points for </span><span class="si">{</span><span class="n">normalized_data_type</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;execution_time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a>        <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error retrieving data for patient </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, type </span><span class="si">{</span><span class="n">normalized_data_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>        <span class="k">return</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.get_processed_fitbit_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_processed_fitbit_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#app.health_platforms.get_processed_fitbit_data" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Retrieve and process Fitbit data in one consolidated function.</p>
<p>This function combines the steps of retrieving raw data from Fitbit's API
and processing it into the application's standardized format. It provides
a convenient wrapper around get_fitbit_data() and process_fitbit_data()
with smart defaults for date ranges and proper error handling.</p>
<p>The function handles:
- Defaulting to a 7-day range when dates are not specified
- Converting date formats as needed
- Retrieving the raw data from Fitbit
- Processing the data into a standardized format
- Error handling at each step</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Patient (app.models.Patient)" href="models.html#app.models.Patient">Patient</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Patient object with Fitbit connection information</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of data to retrieve (must match a key in FITBIT_ENDPOINTS)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_date</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Start date in YYYY-MM-DD format
                       Defaults to 7 days before end_date if not provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_date</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>End date in YYYY-MM-DD format
                     Defaults to current date if not provided</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>list</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processed data in standardized format:
  [{'timestamp': ISO8601, 'value': 123, 'unit': 'xyz'}, ...]
  Returns empty list if data retrieval fails or no data available</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span>
<span class="normal"><a href="#__codelineno-0-1143">1143</a></span>
<span class="normal"><a href="#__codelineno-0-1144">1144</a></span>
<span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1115" name="__codelineno-0-1115"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_processed_fitbit_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a><span class="sd">    Retrieve and process Fitbit data in one consolidated function.</span>
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a><span class="sd">    This function combines the steps of retrieving raw data from Fitbit&#39;s API</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a><span class="sd">    and processing it into the application&#39;s standardized format. It provides</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a><span class="sd">    a convenient wrapper around get_fitbit_data() and process_fitbit_data()</span>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a><span class="sd">    with smart defaults for date ranges and proper error handling.</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a><span class="sd">    The function handles:</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a><span class="sd">    - Defaulting to a 7-day range when dates are not specified</span>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a><span class="sd">    - Converting date formats as needed</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a><span class="sd">    - Retrieving the raw data from Fitbit</span>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a><span class="sd">    - Processing the data into a standardized format</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a><span class="sd">    - Error handling at each step</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a><span class="sd">        patient (Patient): Patient object with Fitbit connection information</span>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a><span class="sd">        data_type (str): Type of data to retrieve (must match a key in FITBIT_ENDPOINTS)</span>
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a><span class="sd">        start_date (str, optional): Start date in YYYY-MM-DD format</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a><span class="sd">                                   Defaults to 7 days before end_date if not provided</span>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a><span class="sd">        end_date (str, optional): End date in YYYY-MM-DD format</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a><span class="sd">                                 Defaults to current date if not provided</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a><span class="sd">        list: Processed data in standardized format:</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a><span class="sd">              [{&#39;timestamp&#39;: ISO8601, &#39;value&#39;: 123, &#39;unit&#39;: &#39;xyz&#39;}, ...]</span>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a><span class="sd">              Returns empty list if data retrieval fails or no data available</span>
<a id="__codelineno-0-1143" name="__codelineno-0-1143"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1144" name="__codelineno-0-1144"></a>    <span class="c1"># If dates are not specified, use default values</span>
<a id="__codelineno-0-1145" name="__codelineno-0-1145"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">end_date</span><span class="p">:</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">start_date</span><span class="p">:</span>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a>        <span class="c1"># Default: 7 days before end date</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a>        <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">end_dt</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a>    <span class="c1"># Generate a unique ID for this data request (for log tracking)</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a>    <span class="n">request_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[:</span><span class="mi">8</span><span class="p">]</span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Data request: </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> for patient </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">end_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a>    <span class="c1"># Convert data_type to lowercase if it&#39;s coming from JavaScript/frontend</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a>    <span class="c1"># JavaScript uses uppercase like &#39;HEART_RATE&#39; while Python backend expects lowercase like &#39;heart_rate&#39;</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a>    <span class="n">normalized_data_type</span> <span class="o">=</span> <span class="n">data_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">data_type</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a>    <span class="c1"># Detailed mapping for all supported data types</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a>    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a>    <span class="s1">&#39;heart_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;heart_rate&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a>    <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="s1">&#39;steps&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a>    <span class="s1">&#39;calories&#39;</span><span class="p">:</span> <span class="s1">&#39;calories&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a>    <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a>    <span class="s1">&#39;active_minutes&#39;</span><span class="p">:</span> <span class="s1">&#39;active_minutes&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a>    <span class="s1">&#39;sleep_duration&#39;</span><span class="p">:</span> <span class="s1">&#39;sleep_duration&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a>    <span class="s1">&#39;floors_climbed&#39;</span><span class="p">:</span> <span class="s1">&#39;floors_climbed&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a>    <span class="s1">&#39;elevation&#39;</span><span class="p">:</span> <span class="s1">&#39;elevation&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a>    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;weight&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a>    <span class="s1">&#39;activity_calories&#39;</span><span class="p">:</span> <span class="s1">&#39;activity_calories&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a>    <span class="s1">&#39;calories_bmr&#39;</span><span class="p">:</span> <span class="s1">&#39;calories_bmr&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a>    <span class="s1">&#39;minutes_sedentary&#39;</span><span class="p">:</span> <span class="s1">&#39;minutes_sedentary&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a>    <span class="s1">&#39;minutes_lightly_active&#39;</span><span class="p">:</span> <span class="s1">&#39;minutes_lightly_active&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>    <span class="s1">&#39;minutes_fairly_active&#39;</span><span class="p">:</span> <span class="s1">&#39;minutes_fairly_active&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a>    <span class="s1">&#39;calories_in&#39;</span><span class="p">:</span> <span class="s1">&#39;calories_in&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a>    <span class="s1">&#39;water&#39;</span><span class="p">:</span> <span class="s1">&#39;water&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a>    <span class="s1">&#39;breathing_rate&#39;</span><span class="p">:</span> <span class="s1">&#39;breathing_rate&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a>    <span class="s1">&#39;oxygen_saturation&#39;</span><span class="p">:</span> <span class="s1">&#39;oxygen_saturation&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a>    <span class="s1">&#39;temperature_core&#39;</span><span class="p">:</span> <span class="s1">&#39;temperature_core&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>    <span class="s1">&#39;temperature_skin&#39;</span><span class="p">:</span> <span class="s1">&#39;temperature_skin&#39;</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>    <span class="p">}</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>    <span class="c1"># Determine the correct API data type</span>
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>    <span class="n">api_data_type</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">normalized_data_type</span><span class="p">,</span> <span class="n">normalized_data_type</span><span class="p">)</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Normalized data type: </span><span class="si">{</span><span class="n">normalized_data_type</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">api_data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a>    <span class="c1"># Check if the data type is supported by Fitbit</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a>    <span class="k">if</span> <span class="n">api_data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FITBIT_ENDPOINTS</span><span class="p">:</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Data type not supported by Fitbit: </span><span class="si">{</span><span class="n">api_data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a>    <span class="c1"># Multiple data retrieval strategies for greater resilience</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a>    <span class="n">error_count</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a>    <span class="c1"># First attempt: range data with full period</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Attempt 1: Requesting range data for </span><span class="si">{</span><span class="n">api_data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a>        <span class="n">raw_data</span> <span class="o">=</span> <span class="n">get_fitbit_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">api_data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a>        <span class="k">if</span> <span class="n">raw_data</span><span class="p">:</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>            <span class="c1"># Process normal range data</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a>            <span class="n">range_results</span> <span class="o">=</span> <span class="n">process_fitbit_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">api_data_type</span><span class="p">)</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a>            <span class="k">if</span> <span class="n">range_results</span><span class="p">:</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">range_results</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">range_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> range data points&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a>                <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] No range data available for the period&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] No data received for </span><span class="si">{</span><span class="n">api_data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a>            <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error retrieving or processing range data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a>        <span class="n">error_count</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a>    <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a>            <span class="c1"># Some timestamps may not have the expected format, so handle exceptions</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a>            <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">sort_error</span><span class="p">:</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>            <span class="n">api_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Unable to sort results: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">sort_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a>    <span class="c1"># Apply any additional transformations (e.g., unit of measure)</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>        <span class="n">endpoint_config</span> <span class="o">=</span> <span class="n">FITBIT_ENDPOINTS</span><span class="p">[</span><span class="n">api_data_type</span><span class="p">]</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>        <span class="n">transform_function</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value_transform&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>        <span class="n">unit</span> <span class="o">=</span> <span class="n">endpoint_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>            <span class="c1"># Make sure each item has the correct unit</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>            <span class="k">if</span> <span class="s1">&#39;unit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>            <span class="c1"># Add the recorded_at field if it doesn&#39;t already exist</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>            <span class="k">if</span> <span class="s1">&#39;recorded_at&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>                <span class="n">item</span><span class="p">[</span><span class="s1">&#39;recorded_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">transform_error</span><span class="p">:</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>        <span class="n">api_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error in final data transformation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">transform_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>    <span class="n">api_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Processing completed, returning </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> data points for </span><span class="si">{</span><span class="n">api_data_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>    <span class="k">return</span> <span class="n">results</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.create_link" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_link</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">platform_name</span><span class="p">)</span></code>

<a href="#app.health_platforms.create_link" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create a connection link for a patient to connect to a health platform.</p>
<p>This API endpoint generates a unique, time-limited URL that can be shared
with a patient to authorize connection to their health platform account
(like Fitbit). The link includes a secure UUID and platform information.
Once created, the link can be sent to the patient via email or other means.</p>
<p>The function performs several validations:
- Verifies the patient exists
- Ensures the requesting doctor has permission to manage this patient
- Validates that the platform name is supported
- Checks if the patient already has a connection to this platform</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the patient in the database</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>platform_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the platform to connect to (must match HealthPlatform enum)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Response</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON object with:
success (bool): Whether the operation succeeded
message (str): Description message
link (dict): Details of the created link (if successful)
    - uuid: Unique identifier for this link
    - url: Full URL that the patient should visit
    - expires_at: ISO 8601 timestamp when the link will expire</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="status-codes" open>
  <summary>Status Codes</summary>
  <p>201: Link created successfully
400: Invalid platform name
403: Not authorized to manage this patient
404: Patient not found
409: Patient already connected to this platform
500: Server error</p>
</details>        <p>Route: /health/link
Method: POST
Auth: Required (Doctor)</p>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span>
<span class="normal"><a href="#__codelineno-0-1306">1306</a></span>
<span class="normal"><a href="#__codelineno-0-1307">1307</a></span>
<span class="normal"><a href="#__codelineno-0-1308">1308</a></span>
<span class="normal"><a href="#__codelineno-0-1309">1309</a></span>
<span class="normal"><a href="#__codelineno-0-1310">1310</a></span>
<span class="normal"><a href="#__codelineno-0-1311">1311</a></span>
<span class="normal"><a href="#__codelineno-0-1312">1312</a></span>
<span class="normal"><a href="#__codelineno-0-1313">1313</a></span>
<span class="normal"><a href="#__codelineno-0-1314">1314</a></span>
<span class="normal"><a href="#__codelineno-0-1315">1315</a></span>
<span class="normal"><a href="#__codelineno-0-1316">1316</a></span>
<span class="normal"><a href="#__codelineno-0-1317">1317</a></span>
<span class="normal"><a href="#__codelineno-0-1318">1318</a></span>
<span class="normal"><a href="#__codelineno-0-1319">1319</a></span>
<span class="normal"><a href="#__codelineno-0-1320">1320</a></span>
<span class="normal"><a href="#__codelineno-0-1321">1321</a></span>
<span class="normal"><a href="#__codelineno-0-1322">1322</a></span>
<span class="normal"><a href="#__codelineno-0-1323">1323</a></span>
<span class="normal"><a href="#__codelineno-0-1324">1324</a></span>
<span class="normal"><a href="#__codelineno-0-1325">1325</a></span>
<span class="normal"><a href="#__codelineno-0-1326">1326</a></span>
<span class="normal"><a href="#__codelineno-0-1327">1327</a></span>
<span class="normal"><a href="#__codelineno-0-1328">1328</a></span>
<span class="normal"><a href="#__codelineno-0-1329">1329</a></span>
<span class="normal"><a href="#__codelineno-0-1330">1330</a></span>
<span class="normal"><a href="#__codelineno-0-1331">1331</a></span>
<span class="normal"><a href="#__codelineno-0-1332">1332</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1249" name="__codelineno-0-1249"></a><span class="nd">@health_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/create_link/&lt;int:patient_id&gt;/&lt;string:platform_name&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a><span class="nd">@login_required</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a><span class="k">def</span><span class="w"> </span><span class="nf">create_link</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">platform_name</span><span class="p">):</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a><span class="sd">    Create a connection link for a patient to connect to a health platform.</span>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a><span class="sd">    This API endpoint generates a unique, time-limited URL that can be shared</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a><span class="sd">    with a patient to authorize connection to their health platform account</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a><span class="sd">    (like Fitbit). The link includes a secure UUID and platform information.</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a><span class="sd">    Once created, the link can be sent to the patient via email or other means.</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a><span class="sd">    The function performs several validations:</span>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a><span class="sd">    - Verifies the patient exists</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a><span class="sd">    - Ensures the requesting doctor has permission to manage this patient</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a><span class="sd">    - Validates that the platform name is supported</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a><span class="sd">    - Checks if the patient already has a connection to this platform</span>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a><span class="sd">        patient_id (int): ID of the patient in the database</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a><span class="sd">        platform_name (str): Name of the platform to connect to (must match HealthPlatform enum)</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a><span class="sd">        Response: JSON object with:</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a><span class="sd">            success (bool): Whether the operation succeeded</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a><span class="sd">            message (str): Description message</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a><span class="sd">            link (dict): Details of the created link (if successful)</span>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a><span class="sd">                - uuid: Unique identifier for this link</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a><span class="sd">                - url: Full URL that the patient should visit</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a><span class="sd">                - expires_at: ISO 8601 timestamp when the link will expire</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a><span class="sd">    Status Codes:</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a><span class="sd">        201: Link created successfully</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a><span class="sd">        400: Invalid platform name</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a><span class="sd">        403: Not authorized to manage this patient</span>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a><span class="sd">        404: Patient not found</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a><span class="sd">        409: Patient already connected to this platform</span>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a><span class="sd">        500: Server error</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a><span class="sd">    Route: /health/link</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a><span class="sd">    Method: POST</span>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a><span class="sd">    Auth: Required (Doctor)</span>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>        <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a>        <span class="c1"># Ensure the doctor is associated with this patient</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a>        <span class="k">if</span> <span class="n">patient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;You are not authorized to manage this patient&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>            <span class="p">}),</span> <span class="mi">403</span>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>        <span class="c1"># Convert platform name to enum</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>            <span class="n">platform</span> <span class="o">=</span> <span class="n">HealthPlatform</span><span class="p">(</span><span class="n">platform_name</span><span class="p">)</span>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1306" name="__codelineno-0-1306"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1307" name="__codelineno-0-1307"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid platform name&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1308" name="__codelineno-0-1308"></a>            <span class="p">}),</span> <span class="mi">400</span>
<a id="__codelineno-0-1309" name="__codelineno-0-1309"></a>
<a id="__codelineno-0-1310" name="__codelineno-0-1310"></a>        <span class="c1"># Generate link</span>
<a id="__codelineno-0-1311" name="__codelineno-0-1311"></a>        <span class="n">link</span> <span class="o">=</span> <span class="n">generate_platform_link</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
<a id="__codelineno-0-1312" name="__codelineno-0-1312"></a>
<a id="__codelineno-0-1313" name="__codelineno-0-1313"></a>        <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
<a id="__codelineno-0-1314" name="__codelineno-0-1314"></a>            <span class="c1"># Return link details</span>
<a id="__codelineno-0-1315" name="__codelineno-0-1315"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1316" name="__codelineno-0-1316"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1317" name="__codelineno-0-1317"></a>                <span class="s1">&#39;link_uuid&#39;</span><span class="p">:</span> <span class="n">link</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
<a id="__codelineno-0-1318" name="__codelineno-0-1318"></a>                <span class="s1">&#39;expires_at&#39;</span><span class="p">:</span> <span class="n">link</span><span class="o">.</span><span class="n">expires_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
<a id="__codelineno-0-1319" name="__codelineno-0-1319"></a>                <span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="n">platform</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-1320" name="__codelineno-0-1320"></a>                <span class="s1">&#39;connect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;health.connect_platform&#39;</span><span class="p">,</span> <span class="n">link_uuid</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1321" name="__codelineno-0-1321"></a>            <span class="p">})</span>
<a id="__codelineno-0-1322" name="__codelineno-0-1322"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1323" name="__codelineno-0-1323"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1324" name="__codelineno-0-1324"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1325" name="__codelineno-0-1325"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Error generating platform link&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1326" name="__codelineno-0-1326"></a>            <span class="p">}),</span> <span class="mi">500</span>
<a id="__codelineno-0-1327" name="__codelineno-0-1327"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1328" name="__codelineno-0-1328"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating health platform link: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1329" name="__codelineno-0-1329"></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1330" name="__codelineno-0-1330"></a>            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1331" name="__codelineno-0-1331"></a>            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;An error occurred&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1332" name="__codelineno-0-1332"></a>        <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.connect_platform" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">connect_platform</span><span class="p">(</span><span class="n">link_uuid</span><span class="p">)</span></code>

<a href="#app.health_platforms.connect_platform" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handle the patient-facing connection flow to a health platform.</p>
<p>This web endpoint presents the connection interface to patients who have
received a link from their doctor. It displays a page explaining the
health platform connection process and provides buttons to initiate the
OAuth flow for the specific platform (Fitbit, Google Health Connect, etc.).</p>
<p>The function:
- Validates the provided UUID corresponds to an active, non-expired link
- Retrieves the associated patient and platform information
- Renders a user-friendly interface explaining what data will be shared
- Provides platform-specific connection buttons that initiate OAuth</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>link_uuid</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>UUID of the health platform link as generated by create_link()</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Response</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTML page with platform connection UI or error message
     Will redirect to OAuth provider if the user initiates connection</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="template" open>
  <summary>Template</summary>
  <p>health_connect.html - Success case with connection UI
health_connect_result.html - Error cases with appropriate message</p>
</details>        <p>Route: /health/connect/<uuid>
Method: GET
Auth: Not required (patient-facing public URL)</p>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1334">1334</a></span>
<span class="normal"><a href="#__codelineno-0-1335">1335</a></span>
<span class="normal"><a href="#__codelineno-0-1336">1336</a></span>
<span class="normal"><a href="#__codelineno-0-1337">1337</a></span>
<span class="normal"><a href="#__codelineno-0-1338">1338</a></span>
<span class="normal"><a href="#__codelineno-0-1339">1339</a></span>
<span class="normal"><a href="#__codelineno-0-1340">1340</a></span>
<span class="normal"><a href="#__codelineno-0-1341">1341</a></span>
<span class="normal"><a href="#__codelineno-0-1342">1342</a></span>
<span class="normal"><a href="#__codelineno-0-1343">1343</a></span>
<span class="normal"><a href="#__codelineno-0-1344">1344</a></span>
<span class="normal"><a href="#__codelineno-0-1345">1345</a></span>
<span class="normal"><a href="#__codelineno-0-1346">1346</a></span>
<span class="normal"><a href="#__codelineno-0-1347">1347</a></span>
<span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1334" name="__codelineno-0-1334"></a><span class="nd">@health_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/connect/&lt;string:link_uuid&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1335" name="__codelineno-0-1335"></a><span class="k">def</span><span class="w"> </span><span class="nf">connect_platform</span><span class="p">(</span><span class="n">link_uuid</span><span class="p">):</span>
<a id="__codelineno-0-1336" name="__codelineno-0-1336"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1337" name="__codelineno-0-1337"></a><span class="sd">    Handle the patient-facing connection flow to a health platform.</span>
<a id="__codelineno-0-1338" name="__codelineno-0-1338"></a>
<a id="__codelineno-0-1339" name="__codelineno-0-1339"></a><span class="sd">    This web endpoint presents the connection interface to patients who have</span>
<a id="__codelineno-0-1340" name="__codelineno-0-1340"></a><span class="sd">    received a link from their doctor. It displays a page explaining the</span>
<a id="__codelineno-0-1341" name="__codelineno-0-1341"></a><span class="sd">    health platform connection process and provides buttons to initiate the</span>
<a id="__codelineno-0-1342" name="__codelineno-0-1342"></a><span class="sd">    OAuth flow for the specific platform (Fitbit, Google Health Connect, etc.).</span>
<a id="__codelineno-0-1343" name="__codelineno-0-1343"></a>
<a id="__codelineno-0-1344" name="__codelineno-0-1344"></a><span class="sd">    The function:</span>
<a id="__codelineno-0-1345" name="__codelineno-0-1345"></a><span class="sd">    - Validates the provided UUID corresponds to an active, non-expired link</span>
<a id="__codelineno-0-1346" name="__codelineno-0-1346"></a><span class="sd">    - Retrieves the associated patient and platform information</span>
<a id="__codelineno-0-1347" name="__codelineno-0-1347"></a><span class="sd">    - Renders a user-friendly interface explaining what data will be shared</span>
<a id="__codelineno-0-1348" name="__codelineno-0-1348"></a><span class="sd">    - Provides platform-specific connection buttons that initiate OAuth</span>
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a><span class="sd">        link_uuid (str): UUID of the health platform link as generated by create_link()</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a><span class="sd">        Response: HTML page with platform connection UI or error message</span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a><span class="sd">                 Will redirect to OAuth provider if the user initiates connection</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a><span class="sd">    Template:</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a><span class="sd">        health_connect.html - Success case with connection UI</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a><span class="sd">        health_connect_result.html - Error cases with appropriate message</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a><span class="sd">    Route: /health/connect/&lt;uuid&gt;</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a><span class="sd">    Method: GET</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a><span class="sd">    Auth: Not required (patient-facing public URL)</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a>    <span class="c1"># Get the link</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a>    <span class="n">link</span> <span class="o">=</span> <span class="n">get_link_by_uuid</span><span class="p">(</span><span class="n">link_uuid</span><span class="p">)</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="p">:</span>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid or expired link&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The link you are trying to use is invalid or has expired&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a>      <span class="c1"># Check if link is expired</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a>    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;This link has expired&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The link you are trying to use has expired&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a>    <span class="c1"># Check if link was already used</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a>    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;This link has already been used&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The link you are trying to use has already been used&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a>    <span class="c1"># Store link UUID in session for the callback</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a>    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;link_uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">link_uuid</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>    <span class="n">session</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>    <span class="c1"># Get the patient</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>    <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">patient_id</span><span class="p">)</span>
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>    <span class="c1"># Show the connect page</span>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a>                          <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">,</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a>                          <span class="n">patient</span><span class="o">=</span><span class="n">patient</span><span class="p">,</span>
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>                          <span class="n">platform</span><span class="o">=</span><span class="n">link</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.start_auth" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">start_auth</span><span class="p">(</span><span class="n">platform_name</span><span class="p">)</span></code>

<a href="#app.health_platforms.start_auth" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Start the OAuth2 authorization flow for the specified health platform.</p>
<p>This endpoint initiates the OAuth2 authorization flow when a patient clicks
on a platform connection button. It validates the session, retrieves the
appropriate authorization URL for the selected platform, and redirects the
user to the platform's authorization page.</p>
<p>The function handles:
- Session validation to ensure the connection link is valid
- Link validation to prevent expired or misused links
- Platform-specific OAuth2 flow initiation
- Security state parameter setup to prevent CSRF attacks</p>
<p>Currently supported platforms:
- Fitbit
- Google Health Connect (planned)
- Apple Health (planned)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>platform_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the platform to connect to (must match HealthPlatform enum)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Response</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Redirect to the OAuth provider's authorization page or error page
     if validation fails</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Route: /health/start-auth/<platform_name>
Method: GET
Auth: Not required (patient-facing, protected by session and link validation)</p>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span>
<span class="normal"><a href="#__codelineno-0-1416">1416</a></span>
<span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1402" name="__codelineno-0-1402"></a><span class="nd">@health_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/start_auth/&lt;string:platform_name&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a><span class="k">def</span><span class="w"> </span><span class="nf">start_auth</span><span class="p">(</span><span class="n">platform_name</span><span class="p">):</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a><span class="sd">    Start the OAuth2 authorization flow for the specified health platform.</span>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a><span class="sd">    This endpoint initiates the OAuth2 authorization flow when a patient clicks</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a><span class="sd">    on a platform connection button. It validates the session, retrieves the</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a><span class="sd">    appropriate authorization URL for the selected platform, and redirects the</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a><span class="sd">    user to the platform&#39;s authorization page.</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a><span class="sd">    The function handles:</span>
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a><span class="sd">    - Session validation to ensure the connection link is valid</span>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a><span class="sd">    - Link validation to prevent expired or misused links</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a><span class="sd">    - Platform-specific OAuth2 flow initiation</span>
<a id="__codelineno-0-1416" name="__codelineno-0-1416"></a><span class="sd">    - Security state parameter setup to prevent CSRF attacks</span>
<a id="__codelineno-0-1417" name="__codelineno-0-1417"></a>
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a><span class="sd">    Currently supported platforms:</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a><span class="sd">    - Fitbit</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a><span class="sd">    - Google Health Connect (planned)</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a><span class="sd">    - Apple Health (planned)</span>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a><span class="sd">        platform_name (str): Name of the platform to connect to (must match HealthPlatform enum)</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a><span class="sd">        Response: Redirect to the OAuth provider&#39;s authorization page or error page</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a><span class="sd">                 if validation fails</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a><span class="sd">    Route: /health/start-auth/&lt;platform_name&gt;</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a><span class="sd">    Method: GET</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a><span class="sd">    Auth: Not required (patient-facing, protected by session and link validation)</span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a><span class="sd">    &quot;&quot;&quot;</span><span class="c1"># Check if we have a link UUID in the session</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a>    <span class="n">link_uuid</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link_uuid&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">link_uuid</span><span class="p">:</span>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid session&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Your session is invalid or has expired&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>    <span class="c1"># Get the link</span>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>    <span class="n">link</span> <span class="o">=</span> <span class="n">get_link_by_uuid</span><span class="p">(</span><span class="n">link_uuid</span><span class="p">)</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span> <span class="ow">or</span> <span class="n">link</span><span class="o">.</span><span class="n">is_expired</span><span class="p">()</span> <span class="ow">or</span> <span class="n">link</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid or expired link&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The link you are trying to use is invalid or has expired&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>      <span class="c1"># Generate the authorization URL based on the platform</span>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>    <span class="k">if</span> <span class="n">platform_name</span> <span class="o">==</span> <span class="s1">&#39;fitbit&#39;</span><span class="p">:</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>        <span class="n">auth_url</span> <span class="o">=</span> <span class="n">get_fitbit_authorization_url</span><span class="p">(</span><span class="n">link_uuid</span><span class="p">)</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">auth_url</span><span class="p">)</span>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Unsupported platform&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The platform you selected is not supported&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.oauth_callback" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">oauth_callback</span><span class="p">()</span></code>

<a href="#app.health_platforms.oauth_callback" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Handle the callback from OAuth2 providers after patient authorization.</p>
<p>This endpoint processes the response from health platforms after a patient
has authorized or denied access to their data. It handles both successful
authorizations (receiving an authorization code) and errors/rejections.</p>
<p>The complete OAuth2 flow involves:
1. Getting the authorization code from the redirect
2. Exchanging the code for access and refresh tokens
3. Storing the tokens securely in the patient record
4. Marking the connection as active in the system
5. Recording the connection event in the audit log</p>
<p>Error handling covers:
- User rejections of authorization
- Missing or invalid state parameters
- Failed token exchanges
- Database errors during token storage</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Response</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>HTML page with success or error message to display to the patient</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Route: /health/oauth-callback
Method: GET
Auth: Not required (patient-facing callback)</p>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span>
<span class="normal"><a href="#__codelineno-0-1529">1529</a></span>
<span class="normal"><a href="#__codelineno-0-1530">1530</a></span>
<span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span>
<span class="normal"><a href="#__codelineno-0-1569">1569</a></span>
<span class="normal"><a href="#__codelineno-0-1570">1570</a></span>
<span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1462" name="__codelineno-0-1462"></a><span class="nd">@health_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/oauth_callback&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a><span class="k">def</span><span class="w"> </span><span class="nf">oauth_callback</span><span class="p">():</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a><span class="sd">    Handle the callback from OAuth2 providers after patient authorization.</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a><span class="sd">    This endpoint processes the response from health platforms after a patient</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a><span class="sd">    has authorized or denied access to their data. It handles both successful</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a><span class="sd">    authorizations (receiving an authorization code) and errors/rejections.</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a><span class="sd">    The complete OAuth2 flow involves:</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a><span class="sd">    1. Getting the authorization code from the redirect</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a><span class="sd">    2. Exchanging the code for access and refresh tokens</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a><span class="sd">    3. Storing the tokens securely in the patient record</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a><span class="sd">    4. Marking the connection as active in the system</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a><span class="sd">    5. Recording the connection event in the audit log</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a><span class="sd">    Error handling covers:</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a><span class="sd">    - User rejections of authorization</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a><span class="sd">    - Missing or invalid state parameters</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a><span class="sd">    - Failed token exchanges</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a><span class="sd">    - Database errors during token storage</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a><span class="sd">        None - Parameters are received via query string</span>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a><span class="sd">               - code: Authorization code from OAuth provider</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a><span class="sd">               - state: Link UUID for verification</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a><span class="sd">               - error/error_description: Details if auth failed</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a><span class="sd">        Response: HTML page with success or error message to display to the patient</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a><span class="sd">    Route: /health/oauth-callback</span>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a><span class="sd">    Method: GET</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a><span class="sd">    Auth: Not required (patient-facing callback)</span>
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>    <span class="c1"># Check for error parameter</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>    <span class="n">error</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Authentication failed: </span><span class="si">%(error)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The health platform authentication failed&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>    <span class="c1"># Get the authorization code</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>    <span class="n">code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;No authorization code received&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;No authorization code was received from the health platform&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>      <span class="c1"># Get the state (link UUID)</span>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>    <span class="n">state</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid state parameter&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The state parameter is missing from the callback&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>    <span class="c1"># Get the link</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>    <span class="n">link</span> <span class="o">=</span> <span class="n">get_link_by_uuid</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="p">:</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid link&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1529" name="__codelineno-0-1529"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1530" name="__codelineno-0-1530"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The link is invalid&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1531" name="__codelineno-0-1531"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a>      <span class="c1"># Check if link is expired</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a>    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">is_expired</span><span class="p">():</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;This link has expired&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The link has expired&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a>    <span class="c1"># Check if link was already used</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a>    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;This link has already been used&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The link has already been used&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a>    <span class="c1"># Get the patient</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a>    <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">patient_id</span><span class="p">)</span>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a>    <span class="c1"># Exchange the code for a token based on the platform</span>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a>    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">FITBIT</span><span class="p">:</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>        <span class="n">token_response</span> <span class="o">=</span> <span class="n">exchange_fitbit_code_for_token</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">token_response</span><span class="p">:</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a>            <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Failed to exchange authorization code for token&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a>                                  <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a>                                  <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Failed to exchange the authorization code for a token&#39;</span><span class="p">))</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>        <span class="c1"># Save the tokens to the patient record</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>        <span class="k">if</span> <span class="n">save_fitbit_tokens</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">token_response</span><span class="p">):</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>            <span class="c1"># Mark the link as used</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>            <span class="n">link</span><span class="o">.</span><span class="n">used</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>              <span class="c1"># Log the connection</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>                <span class="n">log_platform_connection</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">doctor_id</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">FITBIT</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-1569" name="__codelineno-0-1569"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_error</span><span class="p">:</span>
<a id="__codelineno-0-1570" name="__codelineno-0-1570"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging platform connection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">log_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1571" name="__codelineno-0-1571"></a>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a>            <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Successfully connected to Fitbit&#39;</span><span class="p">),</span> <span class="s1">&#39;success&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>                                  <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a>                                  <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Your Fitbit account has been successfully connected&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a>                                  <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a>            <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Failed to save token data&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a>            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>                                  <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a>                                  <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Failed to save the token data&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>                                  <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a>        <span class="n">flash</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Unsupported platform&#39;</span><span class="p">),</span> <span class="s1">&#39;danger&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a>        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;health_connect_result.html&#39;</span><span class="p">,</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a>                              <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a>                              <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The platform is not supported&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>                              <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.check_connection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">check_connection</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span></code>

<a href="#app.health_platforms.check_connection" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>API endpoint to check if a patient is connected to a health platform.</p>
<p>This endpoint allows doctors to verify if a patient has an active connection
to any health platform and retrieve the connection details. It's commonly
used by the frontend to determine if health data can be fetched and when
displaying connection status indicators.</p>
<p>The response includes:
- Connection status (true/false)
- Platform name if connected
- Connection timestamp
- Token expiration information</p>
<p>For disconnected patients, it provides information on why no connection
exists (never connected, expired tokens, manually disconnected).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the patient to check</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Response</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON object with:
connected (bool): Whether the patient is connected
platform (str, optional): Name of the connected platform if any
connected_since (str, optional): ISO timestamp of when connection was established
expires_at (str, optional): ISO timestamp of when the token expires
message (str): Descriptive message about the connection status</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="status-codes" open>
  <summary>Status Codes</summary>
  <p>200: Request processed successfully
403: Not authorized to view this patient's data
404: Patient not found
500: Server error</p>
</details>        <p>Route: /health/connection/<patient_id>
Method: GET
Auth: Required (Doctor)</p>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span>
<span class="normal"><a href="#__codelineno-0-1613">1613</a></span>
<span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span>
<span class="normal"><a href="#__codelineno-0-1622">1622</a></span>
<span class="normal"><a href="#__codelineno-0-1623">1623</a></span>
<span class="normal"><a href="#__codelineno-0-1624">1624</a></span>
<span class="normal"><a href="#__codelineno-0-1625">1625</a></span>
<span class="normal"><a href="#__codelineno-0-1626">1626</a></span>
<span class="normal"><a href="#__codelineno-0-1627">1627</a></span>
<span class="normal"><a href="#__codelineno-0-1628">1628</a></span>
<span class="normal"><a href="#__codelineno-0-1629">1629</a></span>
<span class="normal"><a href="#__codelineno-0-1630">1630</a></span>
<span class="normal"><a href="#__codelineno-0-1631">1631</a></span>
<span class="normal"><a href="#__codelineno-0-1632">1632</a></span>
<span class="normal"><a href="#__codelineno-0-1633">1633</a></span>
<span class="normal"><a href="#__codelineno-0-1634">1634</a></span>
<span class="normal"><a href="#__codelineno-0-1635">1635</a></span>
<span class="normal"><a href="#__codelineno-0-1636">1636</a></span>
<span class="normal"><a href="#__codelineno-0-1637">1637</a></span>
<span class="normal"><a href="#__codelineno-0-1638">1638</a></span>
<span class="normal"><a href="#__codelineno-0-1639">1639</a></span>
<span class="normal"><a href="#__codelineno-0-1640">1640</a></span>
<span class="normal"><a href="#__codelineno-0-1641">1641</a></span>
<span class="normal"><a href="#__codelineno-0-1642">1642</a></span>
<span class="normal"><a href="#__codelineno-0-1643">1643</a></span>
<span class="normal"><a href="#__codelineno-0-1644">1644</a></span>
<span class="normal"><a href="#__codelineno-0-1645">1645</a></span>
<span class="normal"><a href="#__codelineno-0-1646">1646</a></span>
<span class="normal"><a href="#__codelineno-0-1647">1647</a></span>
<span class="normal"><a href="#__codelineno-0-1648">1648</a></span>
<span class="normal"><a href="#__codelineno-0-1649">1649</a></span>
<span class="normal"><a href="#__codelineno-0-1650">1650</a></span>
<span class="normal"><a href="#__codelineno-0-1651">1651</a></span>
<span class="normal"><a href="#__codelineno-0-1652">1652</a></span>
<span class="normal"><a href="#__codelineno-0-1653">1653</a></span>
<span class="normal"><a href="#__codelineno-0-1654">1654</a></span>
<span class="normal"><a href="#__codelineno-0-1655">1655</a></span>
<span class="normal"><a href="#__codelineno-0-1656">1656</a></span>
<span class="normal"><a href="#__codelineno-0-1657">1657</a></span>
<span class="normal"><a href="#__codelineno-0-1658">1658</a></span>
<span class="normal"><a href="#__codelineno-0-1659">1659</a></span>
<span class="normal"><a href="#__codelineno-0-1660">1660</a></span>
<span class="normal"><a href="#__codelineno-0-1661">1661</a></span>
<span class="normal"><a href="#__codelineno-0-1662">1662</a></span>
<span class="normal"><a href="#__codelineno-0-1663">1663</a></span>
<span class="normal"><a href="#__codelineno-0-1664">1664</a></span>
<span class="normal"><a href="#__codelineno-0-1665">1665</a></span>
<span class="normal"><a href="#__codelineno-0-1666">1666</a></span>
<span class="normal"><a href="#__codelineno-0-1667">1667</a></span>
<span class="normal"><a href="#__codelineno-0-1668">1668</a></span>
<span class="normal"><a href="#__codelineno-0-1669">1669</a></span>
<span class="normal"><a href="#__codelineno-0-1670">1670</a></span>
<span class="normal"><a href="#__codelineno-0-1671">1671</a></span>
<span class="normal"><a href="#__codelineno-0-1672">1672</a></span>
<span class="normal"><a href="#__codelineno-0-1673">1673</a></span>
<span class="normal"><a href="#__codelineno-0-1674">1674</a></span>
<span class="normal"><a href="#__codelineno-0-1675">1675</a></span>
<span class="normal"><a href="#__codelineno-0-1676">1676</a></span>
<span class="normal"><a href="#__codelineno-0-1677">1677</a></span>
<span class="normal"><a href="#__codelineno-0-1678">1678</a></span>
<span class="normal"><a href="#__codelineno-0-1679">1679</a></span>
<span class="normal"><a href="#__codelineno-0-1680">1680</a></span>
<span class="normal"><a href="#__codelineno-0-1681">1681</a></span>
<span class="normal"><a href="#__codelineno-0-1682">1682</a></span>
<span class="normal"><a href="#__codelineno-0-1683">1683</a></span>
<span class="normal"><a href="#__codelineno-0-1684">1684</a></span>
<span class="normal"><a href="#__codelineno-0-1685">1685</a></span>
<span class="normal"><a href="#__codelineno-0-1686">1686</a></span>
<span class="normal"><a href="#__codelineno-0-1687">1687</a></span>
<span class="normal"><a href="#__codelineno-0-1688">1688</a></span>
<span class="normal"><a href="#__codelineno-0-1689">1689</a></span>
<span class="normal"><a href="#__codelineno-0-1690">1690</a></span>
<span class="normal"><a href="#__codelineno-0-1691">1691</a></span>
<span class="normal"><a href="#__codelineno-0-1692">1692</a></span>
<span class="normal"><a href="#__codelineno-0-1693">1693</a></span>
<span class="normal"><a href="#__codelineno-0-1694">1694</a></span>
<span class="normal"><a href="#__codelineno-0-1695">1695</a></span>
<span class="normal"><a href="#__codelineno-0-1696">1696</a></span>
<span class="normal"><a href="#__codelineno-0-1697">1697</a></span>
<span class="normal"><a href="#__codelineno-0-1698">1698</a></span>
<span class="normal"><a href="#__codelineno-0-1699">1699</a></span>
<span class="normal"><a href="#__codelineno-0-1700">1700</a></span>
<span class="normal"><a href="#__codelineno-0-1701">1701</a></span>
<span class="normal"><a href="#__codelineno-0-1702">1702</a></span>
<span class="normal"><a href="#__codelineno-0-1703">1703</a></span>
<span class="normal"><a href="#__codelineno-0-1704">1704</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1590" name="__codelineno-0-1590"></a><span class="nd">@health_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/check_connection/&lt;int:patient_id&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a><span class="nd">@login_required</span>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a><span class="k">def</span><span class="w"> </span><span class="nf">check_connection</span><span class="p">(</span><span class="n">patient_id</span><span class="p">):</span>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a><span class="sd">    API endpoint to check if a patient is connected to a health platform.</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a><span class="sd">    This endpoint allows doctors to verify if a patient has an active connection</span>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a><span class="sd">    to any health platform and retrieve the connection details. It&#39;s commonly</span>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a><span class="sd">    used by the frontend to determine if health data can be fetched and when</span>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a><span class="sd">    displaying connection status indicators.</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a><span class="sd">    The response includes:</span>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a><span class="sd">    - Connection status (true/false)</span>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a><span class="sd">    - Platform name if connected</span>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a><span class="sd">    - Connection timestamp</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a><span class="sd">    - Token expiration information</span>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a><span class="sd">    For disconnected patients, it provides information on why no connection</span>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a><span class="sd">    exists (never connected, expired tokens, manually disconnected).</span>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a><span class="sd">        patient_id (int): ID of the patient to check</span>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>
<a id="__codelineno-0-1613" name="__codelineno-0-1613"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1614" name="__codelineno-0-1614"></a><span class="sd">        Response: JSON object with:</span>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a><span class="sd">            connected (bool): Whether the patient is connected</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a><span class="sd">            platform (str, optional): Name of the connected platform if any</span>
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a><span class="sd">            connected_since (str, optional): ISO timestamp of when connection was established</span>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a><span class="sd">            expires_at (str, optional): ISO timestamp of when the token expires</span>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a><span class="sd">            message (str): Descriptive message about the connection status</span>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a><span class="sd">    Status Codes:</span>
<a id="__codelineno-0-1622" name="__codelineno-0-1622"></a><span class="sd">        200: Request processed successfully</span>
<a id="__codelineno-0-1623" name="__codelineno-0-1623"></a><span class="sd">        403: Not authorized to view this patient&#39;s data</span>
<a id="__codelineno-0-1624" name="__codelineno-0-1624"></a><span class="sd">        404: Patient not found</span>
<a id="__codelineno-0-1625" name="__codelineno-0-1625"></a><span class="sd">        500: Server error</span>
<a id="__codelineno-0-1626" name="__codelineno-0-1626"></a>
<a id="__codelineno-0-1627" name="__codelineno-0-1627"></a><span class="sd">    Route: /health/connection/&lt;patient_id&gt;</span>
<a id="__codelineno-0-1628" name="__codelineno-0-1628"></a><span class="sd">    Method: GET</span>
<a id="__codelineno-0-1629" name="__codelineno-0-1629"></a><span class="sd">    Auth: Required (Doctor)</span>
<a id="__codelineno-0-1630" name="__codelineno-0-1630"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1631" name="__codelineno-0-1631"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1632" name="__codelineno-0-1632"></a>        <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
<a id="__codelineno-0-1633" name="__codelineno-0-1633"></a>
<a id="__codelineno-0-1634" name="__codelineno-0-1634"></a>        <span class="c1"># Ensure the doctor is associated with this patient</span>
<a id="__codelineno-0-1635" name="__codelineno-0-1635"></a>        <span class="k">if</span> <span class="n">patient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<a id="__codelineno-0-1636" name="__codelineno-0-1636"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1637" name="__codelineno-0-1637"></a>                <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1638" name="__codelineno-0-1638"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;You are not authorized to view this patient</span><span class="se">\&#39;</span><span class="s1">s data&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1639" name="__codelineno-0-1639"></a>            <span class="p">}),</span> <span class="mi">403</span>
<a id="__codelineno-0-1640" name="__codelineno-0-1640"></a>
<a id="__codelineno-0-1641" name="__codelineno-0-1641"></a>        <span class="c1"># Check if patient has a connected platform</span>
<a id="__codelineno-0-1642" name="__codelineno-0-1642"></a>        <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="p">:</span>
<a id="__codelineno-0-1643" name="__codelineno-0-1643"></a>            <span class="c1"># Verify token is still valid</span>
<a id="__codelineno-0-1644" name="__codelineno-0-1644"></a>            <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="ow">and</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_access_token</span><span class="p">:</span>
<a id="__codelineno-0-1645" name="__codelineno-0-1645"></a>                <span class="c1"># Check if the token is still valid with the service</span>
<a id="__codelineno-0-1646" name="__codelineno-0-1646"></a>                <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-1647" name="__codelineno-0-1647"></a>
<a id="__codelineno-0-1648" name="__codelineno-0-1648"></a>                <span class="c1"># Platform-specific validity check</span>
<a id="__codelineno-0-1649" name="__codelineno-0-1649"></a>                <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">==</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">FITBIT</span><span class="p">:</span>
<a id="__codelineno-0-1650" name="__codelineno-0-1650"></a>                    <span class="c1"># Try to make a simple API call to check if the token is still valid</span>
<a id="__codelineno-0-1651" name="__codelineno-0-1651"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1652" name="__codelineno-0-1652"></a>                        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1653" name="__codelineno-0-1653"></a>                            <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Bearer </span><span class="si">{</span><span class="n">patient</span><span class="o">.</span><span class="n">platform_access_token</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-0-1654" name="__codelineno-0-1654"></a>                        <span class="p">}</span>
<a id="__codelineno-0-1655" name="__codelineno-0-1655"></a>                        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-1656" name="__codelineno-0-1656"></a>                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FITBIT_CONFIG</span><span class="p">[</span><span class="s1">&#39;api_base_url&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/1/user/-/profile.json&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1657" name="__codelineno-0-1657"></a>                            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span>
<a id="__codelineno-0-1658" name="__codelineno-0-1658"></a>                        <span class="p">)</span>
<a id="__codelineno-0-1659" name="__codelineno-0-1659"></a>                        <span class="n">is_valid</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
<a id="__codelineno-0-1660" name="__codelineno-0-1660"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1661" name="__codelineno-0-1661"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking Fitbit token validity: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1662" name="__codelineno-0-1662"></a>                        <span class="n">is_valid</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-1663" name="__codelineno-0-1663"></a>
<a id="__codelineno-0-1664" name="__codelineno-0-1664"></a>                <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
<a id="__codelineno-0-1665" name="__codelineno-0-1665"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1666" name="__codelineno-0-1666"></a>                        <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1667" name="__codelineno-0-1667"></a>                        <span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
<a id="__codelineno-0-1668" name="__codelineno-0-1668"></a>                        <span class="s1">&#39;connected_since&#39;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1669" name="__codelineno-0-1669"></a>                        <span class="s1">&#39;token_expires_at&#39;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-1670" name="__codelineno-0-1670"></a>                    <span class="p">})</span>
<a id="__codelineno-0-1671" name="__codelineno-0-1671"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1672" name="__codelineno-0-1672"></a>                    <span class="c1"># Token is invalid, clear connection data</span>
<a id="__codelineno-0-1673" name="__codelineno-0-1673"></a>                    <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1674" name="__codelineno-0-1674"></a>                    <span class="n">patient</span><span class="o">.</span><span class="n">platform_access_token</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1675" name="__codelineno-0-1675"></a>                    <span class="n">patient</span><span class="o">.</span><span class="n">platform_refresh_token</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1676" name="__codelineno-0-1676"></a>                    <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1677" name="__codelineno-0-1677"></a>                    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-0-1678" name="__codelineno-0-1678"></a>
<a id="__codelineno-0-1679" name="__codelineno-0-1679"></a>                    <span class="c1"># Log the disconnection due to invalid token</span>
<a id="__codelineno-0-1680" name="__codelineno-0-1680"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1681" name="__codelineno-0-1681"></a>                        <span class="n">log_platform_disconnection</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-0-1682" name="__codelineno-0-1682"></a>                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_error</span><span class="p">:</span>
<a id="__codelineno-0-1683" name="__codelineno-0-1683"></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging platform disconnection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">log_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1684" name="__codelineno-0-1684"></a>
<a id="__codelineno-0-1685" name="__codelineno-0-1685"></a>                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1686" name="__codelineno-0-1686"></a>                        <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1687" name="__codelineno-0-1687"></a>                        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Token has expired or been revoked&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1688" name="__codelineno-0-1688"></a>                    <span class="p">})</span>
<a id="__codelineno-0-1689" name="__codelineno-0-1689"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1690" name="__codelineno-0-1690"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1691" name="__codelineno-0-1691"></a>                    <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1692" name="__codelineno-0-1692"></a>                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Incomplete token data&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1693" name="__codelineno-0-1693"></a>                <span class="p">})</span>
<a id="__codelineno-0-1694" name="__codelineno-0-1694"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1695" name="__codelineno-0-1695"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1696" name="__codelineno-0-1696"></a>                <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1697" name="__codelineno-0-1697"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Not connected to any health platform&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1698" name="__codelineno-0-1698"></a>            <span class="p">})</span>
<a id="__codelineno-0-1699" name="__codelineno-0-1699"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1700" name="__codelineno-0-1700"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking connection status: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1701" name="__codelineno-0-1701"></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1702" name="__codelineno-0-1702"></a>            <span class="s1">&#39;connected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1703" name="__codelineno-0-1703"></a>            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Error checking connection status&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1704" name="__codelineno-0-1704"></a>        <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.disconnect_platform" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">disconnect_platform</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span></code>

<a href="#app.health_platforms.disconnect_platform" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>API endpoint to disconnect a patient from a health platform.</p>
<p>This endpoint allows doctors to remove a patient's connection to a health
platform. It revokes the OAuth tokens and clears connection data from the
patient record. This is useful when:
- A patient requests disconnection
- The patient changes accounts
- Privacy concerns require removing access
- Repeated token refresh failures indicate an invalid connection</p>
<p>The function:
- Validates doctor authorization for the patient
- Verifies the platform is valid
- Checks if the patient is actually connected to the specified platform
- Clears all token and connection data
- Adds an audit log entry for the disconnection</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the patient to disconnect</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>platform</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the platform to disconnect (must match HealthPlatform enum)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Response</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON object with:
success (bool): Whether the disconnection was successful
message (str): Description message about the result</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="status-codes" open>
  <summary>Status Codes</summary>
  <p>200: Disconnection successful
400: Invalid platform name
403: Not authorized to manage this patient's connections
404: Patient not found or not connected to specified platform
500: Server error</p>
</details>        <p>Route: /health/disconnect/<patient_id>/<platform>
Method: POST
Auth: Required (Doctor)</p>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1706">1706</a></span>
<span class="normal"><a href="#__codelineno-0-1707">1707</a></span>
<span class="normal"><a href="#__codelineno-0-1708">1708</a></span>
<span class="normal"><a href="#__codelineno-0-1709">1709</a></span>
<span class="normal"><a href="#__codelineno-0-1710">1710</a></span>
<span class="normal"><a href="#__codelineno-0-1711">1711</a></span>
<span class="normal"><a href="#__codelineno-0-1712">1712</a></span>
<span class="normal"><a href="#__codelineno-0-1713">1713</a></span>
<span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span>
<span class="normal"><a href="#__codelineno-0-1730">1730</a></span>
<span class="normal"><a href="#__codelineno-0-1731">1731</a></span>
<span class="normal"><a href="#__codelineno-0-1732">1732</a></span>
<span class="normal"><a href="#__codelineno-0-1733">1733</a></span>
<span class="normal"><a href="#__codelineno-0-1734">1734</a></span>
<span class="normal"><a href="#__codelineno-0-1735">1735</a></span>
<span class="normal"><a href="#__codelineno-0-1736">1736</a></span>
<span class="normal"><a href="#__codelineno-0-1737">1737</a></span>
<span class="normal"><a href="#__codelineno-0-1738">1738</a></span>
<span class="normal"><a href="#__codelineno-0-1739">1739</a></span>
<span class="normal"><a href="#__codelineno-0-1740">1740</a></span>
<span class="normal"><a href="#__codelineno-0-1741">1741</a></span>
<span class="normal"><a href="#__codelineno-0-1742">1742</a></span>
<span class="normal"><a href="#__codelineno-0-1743">1743</a></span>
<span class="normal"><a href="#__codelineno-0-1744">1744</a></span>
<span class="normal"><a href="#__codelineno-0-1745">1745</a></span>
<span class="normal"><a href="#__codelineno-0-1746">1746</a></span>
<span class="normal"><a href="#__codelineno-0-1747">1747</a></span>
<span class="normal"><a href="#__codelineno-0-1748">1748</a></span>
<span class="normal"><a href="#__codelineno-0-1749">1749</a></span>
<span class="normal"><a href="#__codelineno-0-1750">1750</a></span>
<span class="normal"><a href="#__codelineno-0-1751">1751</a></span>
<span class="normal"><a href="#__codelineno-0-1752">1752</a></span>
<span class="normal"><a href="#__codelineno-0-1753">1753</a></span>
<span class="normal"><a href="#__codelineno-0-1754">1754</a></span>
<span class="normal"><a href="#__codelineno-0-1755">1755</a></span>
<span class="normal"><a href="#__codelineno-0-1756">1756</a></span>
<span class="normal"><a href="#__codelineno-0-1757">1757</a></span>
<span class="normal"><a href="#__codelineno-0-1758">1758</a></span>
<span class="normal"><a href="#__codelineno-0-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-0-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-0-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-0-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-0-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-0-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-0-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-0-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-0-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-0-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-0-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-0-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-0-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1706" name="__codelineno-0-1706"></a><span class="nd">@health_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/disconnect/&lt;int:patient_id&gt;/&lt;string:platform&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<a id="__codelineno-0-1707" name="__codelineno-0-1707"></a><span class="nd">@login_required</span>
<a id="__codelineno-0-1708" name="__codelineno-0-1708"></a><span class="k">def</span><span class="w"> </span><span class="nf">disconnect_platform</span><span class="p">(</span><span class="n">patient_id</span><span class="p">,</span> <span class="n">platform</span><span class="p">):</span>
<a id="__codelineno-0-1709" name="__codelineno-0-1709"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1710" name="__codelineno-0-1710"></a><span class="sd">    API endpoint to disconnect a patient from a health platform.</span>
<a id="__codelineno-0-1711" name="__codelineno-0-1711"></a>
<a id="__codelineno-0-1712" name="__codelineno-0-1712"></a><span class="sd">    This endpoint allows doctors to remove a patient&#39;s connection to a health</span>
<a id="__codelineno-0-1713" name="__codelineno-0-1713"></a><span class="sd">    platform. It revokes the OAuth tokens and clears connection data from the</span>
<a id="__codelineno-0-1714" name="__codelineno-0-1714"></a><span class="sd">    patient record. This is useful when:</span>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a><span class="sd">    - A patient requests disconnection</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a><span class="sd">    - The patient changes accounts</span>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a><span class="sd">    - Privacy concerns require removing access</span>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a><span class="sd">    - Repeated token refresh failures indicate an invalid connection</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a><span class="sd">    The function:</span>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a><span class="sd">    - Validates doctor authorization for the patient</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a><span class="sd">    - Verifies the platform is valid</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a><span class="sd">    - Checks if the patient is actually connected to the specified platform</span>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a><span class="sd">    - Clears all token and connection data</span>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a><span class="sd">    - Adds an audit log entry for the disconnection</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a><span class="sd">        patient_id (int): ID of the patient to disconnect</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a><span class="sd">        platform (str): Name of the platform to disconnect (must match HealthPlatform enum)</span>
<a id="__codelineno-0-1730" name="__codelineno-0-1730"></a>
<a id="__codelineno-0-1731" name="__codelineno-0-1731"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1732" name="__codelineno-0-1732"></a><span class="sd">        Response: JSON object with:</span>
<a id="__codelineno-0-1733" name="__codelineno-0-1733"></a><span class="sd">            success (bool): Whether the disconnection was successful</span>
<a id="__codelineno-0-1734" name="__codelineno-0-1734"></a><span class="sd">            message (str): Description message about the result</span>
<a id="__codelineno-0-1735" name="__codelineno-0-1735"></a>
<a id="__codelineno-0-1736" name="__codelineno-0-1736"></a><span class="sd">    Status Codes:</span>
<a id="__codelineno-0-1737" name="__codelineno-0-1737"></a><span class="sd">        200: Disconnection successful</span>
<a id="__codelineno-0-1738" name="__codelineno-0-1738"></a><span class="sd">        400: Invalid platform name</span>
<a id="__codelineno-0-1739" name="__codelineno-0-1739"></a><span class="sd">        403: Not authorized to manage this patient&#39;s connections</span>
<a id="__codelineno-0-1740" name="__codelineno-0-1740"></a><span class="sd">        404: Patient not found or not connected to specified platform</span>
<a id="__codelineno-0-1741" name="__codelineno-0-1741"></a><span class="sd">        500: Server error</span>
<a id="__codelineno-0-1742" name="__codelineno-0-1742"></a>
<a id="__codelineno-0-1743" name="__codelineno-0-1743"></a><span class="sd">    Route: /health/disconnect/&lt;patient_id&gt;/&lt;platform&gt;</span>
<a id="__codelineno-0-1744" name="__codelineno-0-1744"></a><span class="sd">    Method: POST</span>
<a id="__codelineno-0-1745" name="__codelineno-0-1745"></a><span class="sd">    Auth: Required (Doctor)</span>
<a id="__codelineno-0-1746" name="__codelineno-0-1746"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1747" name="__codelineno-0-1747"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1748" name="__codelineno-0-1748"></a>        <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
<a id="__codelineno-0-1749" name="__codelineno-0-1749"></a>
<a id="__codelineno-0-1750" name="__codelineno-0-1750"></a>        <span class="c1"># Ensure the doctor is associated with this patient</span>
<a id="__codelineno-0-1751" name="__codelineno-0-1751"></a>        <span class="k">if</span> <span class="n">patient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<a id="__codelineno-0-1752" name="__codelineno-0-1752"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1753" name="__codelineno-0-1753"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1754" name="__codelineno-0-1754"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;You are not authorized to manage this patient</span><span class="se">\&#39;</span><span class="s1">s connections&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1755" name="__codelineno-0-1755"></a>            <span class="p">}),</span> <span class="mi">403</span>
<a id="__codelineno-0-1756" name="__codelineno-0-1756"></a>
<a id="__codelineno-0-1757" name="__codelineno-0-1757"></a>        <span class="c1"># Convert platform string to enum value</span>
<a id="__codelineno-0-1758" name="__codelineno-0-1758"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1759" name="__codelineno-0-1759"></a>            <span class="n">platform_enum</span> <span class="o">=</span> <span class="n">HealthPlatform</span><span class="p">(</span><span class="n">platform</span><span class="p">)</span>
<a id="__codelineno-0-1760" name="__codelineno-0-1760"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-1761" name="__codelineno-0-1761"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1762" name="__codelineno-0-1762"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1763" name="__codelineno-0-1763"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid platform specified&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1764" name="__codelineno-0-1764"></a>            <span class="p">}),</span> <span class="mi">400</span>
<a id="__codelineno-0-1765" name="__codelineno-0-1765"></a>
<a id="__codelineno-0-1766" name="__codelineno-0-1766"></a>        <span class="c1"># Check if patient is actually connected to this platform</span>
<a id="__codelineno-0-1767" name="__codelineno-0-1767"></a>        <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">!=</span> <span class="n">platform_enum</span><span class="p">:</span>
<a id="__codelineno-0-1768" name="__codelineno-0-1768"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1769" name="__codelineno-0-1769"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1770" name="__codelineno-0-1770"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Patient is not connected to the specified platform&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1771" name="__codelineno-0-1771"></a>            <span class="p">}),</span> <span class="mi">400</span>
<a id="__codelineno-0-1772" name="__codelineno-0-1772"></a>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>        <span class="c1"># Clear connection data</span>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">platform_access_token</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">platform_refresh_token</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>        <span class="n">patient</span><span class="o">.</span><span class="n">platform_token_expires_at</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a>        <span class="c1"># Log the disconnection</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>            <span class="n">log_platform_disconnection</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">platform</span><span class="p">)</span>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_error</span><span class="p">:</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging platform disconnection: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">log_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a>            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a>            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Successfully disconnected from health platform&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a>        <span class="p">})</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error disconnecting from health platform: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a>            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a>            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Error disconnecting from health platform&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a>        <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="app.health_platforms.get_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_data</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">)</span></code>

<a href="#app.health_platforms.get_data" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>API endpoint to retrieve health data from connected platforms.</p>
<p>This endpoint provides a unified interface for the frontend to request health
data of various types for a patient. It's primarily used for AJAX requests from
the vitals monitoring page to populate charts and data tables. The function
handles platform selection, permission checking, and returns data in a consistent
format regardless of the source platform.</p>
<p>The endpoint supports date range filtering and leverages the caching system
to minimize API calls to health platforms. All data is returned in a standardized
format suitable for direct use in frontend visualizations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of data to retrieve (must be a valid VitalSignType value)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>patient_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID of the patient to get data for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="query-parameters" open>
  <summary>Query Parameters</summary>
  <p>start_date (str, optional): Start date in YYYY-MM-DD format
                           Defaults to 7 days before end_date
end_date (str, optional): End date in YYYY-MM-DD format
                         Defaults to current date</p>
</details>

    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>Response</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON object with:
success (bool): Whether the data retrieval was successful
data (list): Array of data points in format:
      [{'timestamp': ISO8601, 'value': numeric, 'unit': string}, ...]
message (str, optional): Error description if success is false</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="status-codes" open>
  <summary>Status Codes</summary>
  <p>200: Data retrieved successfully
403: Not authorized to access this patient's data
404: Patient not found
500: Server error or health platform error</p>
</details>        <p>Route: /health/data/<data_type>/<patient_id>
Method: GET
Auth: Required (Doctor)</p>


            <details class="quote">
              <summary>Source code in <code>app/health_platforms.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span>
<span class="normal"><a href="#__codelineno-0-1802">1802</a></span>
<span class="normal"><a href="#__codelineno-0-1803">1803</a></span>
<span class="normal"><a href="#__codelineno-0-1804">1804</a></span>
<span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span>
<span class="normal"><a href="#__codelineno-0-1815">1815</a></span>
<span class="normal"><a href="#__codelineno-0-1816">1816</a></span>
<span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span>
<span class="normal"><a href="#__codelineno-0-1825">1825</a></span>
<span class="normal"><a href="#__codelineno-0-1826">1826</a></span>
<span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span>
<span class="normal"><a href="#__codelineno-0-1857">1857</a></span>
<span class="normal"><a href="#__codelineno-0-1858">1858</a></span>
<span class="normal"><a href="#__codelineno-0-1859">1859</a></span>
<span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1797" name="__codelineno-0-1797"></a><span class="nd">@health_bp</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/data/&lt;string:data_type&gt;/&lt;int:patient_id&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a><span class="nd">@login_required</span>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">):</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a><span class="sd">    API endpoint to retrieve health data from connected platforms.</span>
<a id="__codelineno-0-1802" name="__codelineno-0-1802"></a>
<a id="__codelineno-0-1803" name="__codelineno-0-1803"></a><span class="sd">    This endpoint provides a unified interface for the frontend to request health</span>
<a id="__codelineno-0-1804" name="__codelineno-0-1804"></a><span class="sd">    data of various types for a patient. It&#39;s primarily used for AJAX requests from</span>
<a id="__codelineno-0-1805" name="__codelineno-0-1805"></a><span class="sd">    the vitals monitoring page to populate charts and data tables. The function</span>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a><span class="sd">    handles platform selection, permission checking, and returns data in a consistent</span>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a><span class="sd">    format regardless of the source platform.</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a><span class="sd">    The endpoint supports date range filtering and leverages the caching system</span>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a><span class="sd">    to minimize API calls to health platforms. All data is returned in a standardized</span>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a><span class="sd">    format suitable for direct use in frontend visualizations.</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a><span class="sd">        data_type (str): Type of data to retrieve (must be a valid VitalSignType value)</span>
<a id="__codelineno-0-1815" name="__codelineno-0-1815"></a><span class="sd">        patient_id (int): ID of the patient to get data for</span>
<a id="__codelineno-0-1816" name="__codelineno-0-1816"></a>
<a id="__codelineno-0-1817" name="__codelineno-0-1817"></a><span class="sd">    Query Parameters:</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a><span class="sd">        start_date (str, optional): Start date in YYYY-MM-DD format</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a><span class="sd">                                   Defaults to 7 days before end_date</span>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a><span class="sd">        end_date (str, optional): End date in YYYY-MM-DD format</span>
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a><span class="sd">                                 Defaults to current date</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a>
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a><span class="sd">        Response: JSON object with:</span>
<a id="__codelineno-0-1825" name="__codelineno-0-1825"></a><span class="sd">            success (bool): Whether the data retrieval was successful</span>
<a id="__codelineno-0-1826" name="__codelineno-0-1826"></a><span class="sd">            data (list): Array of data points in format:</span>
<a id="__codelineno-0-1827" name="__codelineno-0-1827"></a><span class="sd">                  [{&#39;timestamp&#39;: ISO8601, &#39;value&#39;: numeric, &#39;unit&#39;: string}, ...]</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a><span class="sd">            message (str, optional): Error description if success is false</span>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a><span class="sd">    Status Codes:</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a><span class="sd">        200: Data retrieved successfully</span>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a><span class="sd">        403: Not authorized to access this patient&#39;s data</span>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a><span class="sd">        404: Patient not found</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a><span class="sd">        500: Server error or health platform error</span>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a><span class="sd">    Route: /health/data/&lt;data_type&gt;/&lt;patient_id&gt;</span>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a><span class="sd">    Method: GET</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a><span class="sd">    Auth: Required (Doctor)</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a>        <span class="c1"># Get start_date and end_date from query params if provided</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_date&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a>        <span class="n">end_date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end_date&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a>        <span class="n">patient</span> <span class="o">=</span> <span class="n">Patient</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_or_404</span><span class="p">(</span><span class="n">patient_id</span><span class="p">)</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a>        <span class="c1"># Ensure the doctor is associated with this patient</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a>        <span class="k">if</span> <span class="n">patient</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_user</span><span class="o">.</span><span class="n">patients</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;You are not authorized to view this patient</span><span class="se">\&#39;</span><span class="s1">s data&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a>            <span class="p">}),</span> <span class="mi">403</span>
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a>        <span class="c1"># Check if patient is connected to a platform</span>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="p">:</span>
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1857" name="__codelineno-0-1857"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1858" name="__codelineno-0-1858"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Patient is not connected to any health platform&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1859" name="__codelineno-0-1859"></a>                <span class="s1">&#39;connect_url&#39;</span><span class="p">:</span> <span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;views.patient_vitals&#39;</span><span class="p">,</span> <span class="n">patient_id</span><span class="o">=</span><span class="n">patient_id</span><span class="p">)</span>
<a id="__codelineno-0-1860" name="__codelineno-0-1860"></a>            <span class="p">}),</span> <span class="mi">404</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a>        <span class="c1"># Get data based on the platform</span>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a>        <span class="k">if</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span> <span class="o">==</span> <span class="n">HealthPlatform</span><span class="o">.</span><span class="n">FITBIT</span><span class="p">:</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">get_processed_fitbit_data</span><span class="p">(</span><span class="n">patient</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a>            <span class="c1"># Log the data sync</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a>                <span class="n">result_summary</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a>                    <span class="s1">&#39;data_points&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a>                    <span class="s1">&#39;start_date&#39;</span><span class="p">:</span> <span class="n">start_date</span><span class="p">,</span>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a>                    <span class="s1">&#39;end_date&#39;</span><span class="p">:</span> <span class="n">end_date</span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a>                <span class="p">}</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a>                <span class="n">log_data_sync</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span> <span class="n">result_summary</span><span class="p">)</span>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">log_error</span><span class="p">:</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error logging data sync: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">log_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a>            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a>                <span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a>            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a>                <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a>                <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Unsupported platform&#39;</span><span class="p">),</span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a>                <span class="s1">&#39;platform&#39;</span><span class="p">:</span> <span class="n">patient</span><span class="o">.</span><span class="n">connected_platform</span><span class="o">.</span><span class="n">value</span>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a>            <span class="p">}),</span> <span class="mi">400</span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving health platform data: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a>        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;An error occurred&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>        <span class="p">}),</span> <span class="mi">500</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copiato", "clipboard.copy": "Copia", "search.result.more.one": "1 altro in questa pagina", "search.result.more.other": "# altri in questa pagina", "search.result.none": "Nessun documento trovato", "search.result.one": "1 documento trovato", "search.result.other": "# documenti trovati", "search.result.placeholder": "Scrivi per iniziare a cercare", "search.result.term.missing": "Non presente", "select.version": "Seleziona la versione"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>