{% extends "base.html" %}

{% block title %}{{ _('Generate Specific Report') }} - {{ patient.first_name }} {{ patient.last_name }}{% endblock %}

{% block styles %}
<style>
    .vital-type-card {
        transition: all 0.3s ease;
    }
    
    .vital-type-card.border-danger {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
    
    .period-error {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    
    .charts-selection {
        border-top: 1px solid rgba(0,0,0,.125);
        padding-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-file-medical me-2 text-info"></i>
            {{ _('Generate Specific Report') }}
        </h1>
        <a href="{{ url_for('views.patient_vitals', patient_id=patient.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> {{ _('Back to Vitals') }}
        </a>
    </div>
    
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">{{ _('Patient') }}: {{ patient.first_name }} {{ patient.last_name }}</h5>
        </div>
        <div class="card-body">
            <!-- Report Form -->
            <form action="{{ url_for('views.generate_specific_report', patient_id=patient.id) }}" method="post" id="specificReportForm">
                <!-- Summary section -->
                <div class="mb-4">
                    <label for="summary" class="form-label">{{ _('Summary (Optional)') }}</label>
                    <textarea class="form-control" id="summary" name="summary" rows="4" placeholder="{{ _('Add an optional summary for this report. This will appear in the report but will not be saved in the database.') }}"></textarea>
                    <div class="form-text">{{ _('This summary will only be included in this report and will not be saved for future reference.') }}</div>
                </div>
                
                <div class="row">
                    <!-- Notes section -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">{{ _('Medical Notes') }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-end mb-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllNotes">{{ _('Select All') }}</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllNotes">{{ _('Deselect All') }}</button>
                                </div>
                                
                                <div style="max-height: 300px; overflow-y: auto;">
                                    {% if notes %}
                                        {% for note in notes %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input note-checkbox" type="checkbox" id="note{{ note.id }}" name="selected_notes" value="{{ note.id }}">
                                            <label class="form-check-label" for="note{{ note.id }}">
                                                <span class="fw-bold">{{ note.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                                <p class="mb-0 text-muted">{{ note.content|truncate(50) }}</p>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-center text-muted py-3">{{ _('No notes available') }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Observations section -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">{{ _('Observations') }}</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-end mb-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllObservations">{{ _('Select All') }}</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllObservations">{{ _('Deselect All') }}</button>
                                </div>
                                
                                <div style="max-height: 300px; overflow-y: auto;">
                                    {% set has_any_observations = false %}
                                    {% for vital_type, observations in observations_by_type.items() %}
                                        {% if observations|length > 0 %}
                                            {% set has_any_observations = true %}
                                            <h6 class="border-bottom pb-1 mt-3">{{ _(vital_type|replace('_', ' ')|title) }}</h6>
                                            {% for obs in observations %}
                                            <div class="form-check mb-2">
                                                <input class="form-check-input observation-checkbox" type="checkbox" id="obs{{ obs.id }}" name="selected_observations" value="{{ obs.id }}">
                                                <label class="form-check-label" for="obs{{ obs.id }}">
                                                    <span class="fw-bold">{{ obs.start_date.strftime('%Y-%m-%d') }} - {{ obs.end_date.strftime('%Y-%m-%d') }}</span>
                                                    <p class="mb-0 text-muted">{{ obs.content|truncate(50) }}</p>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if not has_any_observations %}
                                        <p class="text-center text-muted py-3">{{ _('No observations available') }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vital Types and Charts section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">{{ _('Vital Signs and Charts') }}</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-end mb-3">
                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllVitalTypes">{{ _('Select All Types') }}</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllVitalTypes">{{ _('Deselect All Types') }}</button>
                        </div>
                        
                        <div class="row">
                            {% for vital_type in vital_types %}
                            <div class="col-md-6 mb-3">
                                <div class="card vital-type-card">
                                    <div class="card-header">
                                        <div class="form-check">
                                            <input class="form-check-input vital-type-checkbox" type="checkbox" id="vitalType{{ loop.index }}" name="selected_vital_types" value="{{ vital_type.value }}">
                                            <label class="form-check-label fw-bold" for="vitalType{{ loop.index }}">
                                                {{ _(vital_type.value|replace('_', ' ')|title) }}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="card-body charts-selection d-none">
                                        <div class="form-text mb-2">{{ _('Select time periods for charts:') }}</div>
                                        <div class="d-flex justify-content-end mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 select-all-periods" data-vital-type="{{ vital_type.value }}">{{ _('Select All Periods') }}</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary deselect-all-periods" data-vital-type="{{ vital_type.value }}">{{ _('Deselect All') }}</button>
                                        </div>
                                        <div class="d-flex flex-wrap gap-2">
                                            <div class="form-check">
                                                <input class="form-check-input period-checkbox" type="checkbox" id="chart1d{{ loop.index }}" name="charts_{{ vital_type.value }}" value="1d" data-vital-type="{{ vital_type.value }}">
                                                <label class="form-check-label" for="chart1d{{ loop.index }}">{{ _('1 Day') }}</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input period-checkbox" type="checkbox" id="chart7d{{ loop.index }}" name="charts_{{ vital_type.value }}" value="7d" data-vital-type="{{ vital_type.value }}">
                                                <label class="form-check-label" for="chart7d{{ loop.index }}">{{ _('7 Days') }}</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input period-checkbox" type="checkbox" id="chart1m{{ loop.index }}" name="charts_{{ vital_type.value }}" value="1m" data-vital-type="{{ vital_type.value }}">
                                                <label class="form-check-label" for="chart1m{{ loop.index }}">{{ _('1 Month') }}</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input period-checkbox" type="checkbox" id="chart3m{{ loop.index }}" name="charts_{{ vital_type.value }}" value="3m" data-vital-type="{{ vital_type.value }}">
                                                <label class="form-check-label" for="chart3m{{ loop.index }}">{{ _('3 Months') }}</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input period-checkbox" type="checkbox" id="chart1y{{ loop.index }}" name="charts_{{ vital_type.value }}" value="1y" data-vital-type="{{ vital_type.value }}">
                                                <label class="form-check-label" for="chart1y{{ loop.index }}">{{ _('1 Year') }}</label>
                                            </div>
                                        </div>
                                        <div class="invalid-feedback d-none period-error">{{ _('Please select at least one time period') }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('views.patient_vitals', patient_id=patient.id) }}" class="btn btn-secondary">
                        {{ _('Cancel') }}
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-pdf me-1"></i> {{ _('Generate Report') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Show/hide charts selection when vital type is checked/unchecked
        const vitalTypeCheckboxes = document.querySelectorAll('.vital-type-checkbox');
        vitalTypeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const card = this.closest('.vital-type-card');
                const chartsSelection = card.querySelector('.charts-selection');
                
                if (this.checked) {
                    chartsSelection.classList.remove('d-none');
                } else {
                    chartsSelection.classList.add('d-none');
                    // Deselect all period checkboxes when vital type is deselected
                    card.querySelectorAll('.period-checkbox').forEach(periodCheckbox => {
                        periodCheckbox.checked = false;
                    });
                }
            });
        });
        
        // Select/deselect all notes
        document.getElementById('selectAllNotes').addEventListener('click', function() {
            document.querySelectorAll('.note-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        });
        
        document.getElementById('deselectAllNotes').addEventListener('click', function() {
            document.querySelectorAll('.note-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        });
        
        // Select/deselect all observations
        document.getElementById('selectAllObservations').addEventListener('click', function() {
            document.querySelectorAll('.observation-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        });
        
        document.getElementById('deselectAllObservations').addEventListener('click', function() {
            document.querySelectorAll('.observation-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        });
        
        // Select/deselect all vital types
        document.getElementById('selectAllVitalTypes').addEventListener('click', function() {
            document.querySelectorAll('.vital-type-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        });
        
        document.getElementById('deselectAllVitalTypes').addEventListener('click', function() {
            document.querySelectorAll('.vital-type-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        });
        
        // Select/deselect all time periods for a specific vital type
        document.querySelectorAll('.select-all-periods').forEach(button => {
            button.addEventListener('click', function() {
                const vitalType = this.getAttribute('data-vital-type');
                document.querySelectorAll(`.period-checkbox[data-vital-type="${vitalType}"]`).forEach(checkbox => {
                    checkbox.checked = true;
                });
                // Hide error message if it was shown
                const periodError = this.closest('.charts-selection').querySelector('.period-error');
                periodError.classList.add('d-none');
            });
        });
        
        document.querySelectorAll('.deselect-all-periods').forEach(button => {
            button.addEventListener('click', function() {
                const vitalType = this.getAttribute('data-vital-type');
                document.querySelectorAll(`.period-checkbox[data-vital-type="${vitalType}"]`).forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
        });
        
        // Form validation before submission
        document.getElementById('specificReportForm').addEventListener('submit', function(event) {
            let isValid = true;
            
            // Check that selected vital types have at least one time period selected
            document.querySelectorAll('.vital-type-checkbox:checked').forEach(checkbox => {
                const vitalType = checkbox.value;
                const periodCheckboxes = document.querySelectorAll(`.period-checkbox[data-vital-type="${vitalType}"]:checked`);
                
                if (periodCheckboxes.length === 0) {
                    // Show error message
                    const periodError = checkbox.closest('.vital-type-card').querySelector('.period-error');
                    periodError.classList.remove('d-none');
                    isValid = false;
                    
                    // Add red border to the card
                    checkbox.closest('.vital-type-card').classList.add('border-danger');
                } else {
                    // Hide error message if it was shown
                    const periodError = checkbox.closest('.vital-type-card').querySelector('.period-error');
                    periodError.classList.add('d-none');
                    
                    // Remove red border
                    checkbox.closest('.vital-type-card').classList.remove('border-danger');
                }
            });
            
            // Prevent form submission if validation fails
            if (!isValid) {
                event.preventDefault();
                alert("{{ _('Please select at least one time period for each selected vital type') }}");
                window.scrollTo(0, 0);
            }
        });
    });
</script>
{% endblock %}