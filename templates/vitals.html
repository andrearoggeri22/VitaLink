{% extends "base.html" %}

{% block title %}{{ _('Vital Signs') }} - {{ patient.first_name }} {{ patient.last_name }} - {{ _('Healthcare Monitoring Platform') }}{% endblock %}

{% block head %}
<meta name="current-doctor-id" content="{{ current_user.id }}">
<script>
    // Definisci l'ID del medico attuale come variabile globale
    const CURRENT_DOCTOR_ID = {{ current_user.id }};
</script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ _('Vital Signs') }}</h1>
        <h5 class="text-muted">{{ patient.first_name }} {{ patient.last_name }}</h5>
        <span class="badge bg-secondary patient-id">ID: {{ patient.uuid }}</span>
    </div>
    
    <div>
        <a href="{{ url_for('views.patient_detail', patient_id=patient.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> {{ _('Back to Patient') }}
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-4 mb-4">
        <!-- Health Platform Connection -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-link me-2"></i> {{ _('Health Platform') }}</h5>
                <button id="syncHealthBtn" class="btn btn-light sync-button">
                    <i class="fas fa-sync me-1"></i> {{ _('Health Sync') }}
                </button>
            </div>
            <div class="card-body">
                <div id="connectionDetails">
                    <div class="text-center py-3" id="connectionLoading">
                        <div class="spinner-border text-primary mb-2" role="status">
                            <span class="visually-hidden">{{ _('Loading...') }}</span>
                        </div>
                        <p class="text-muted">{{ _('Checking connection status...') }}</p>
                    </div>
                    
                    <div id="connectionActive" class="d-none">
                        <div class="alert alert-success mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check-circle me-3 fs-3"></i>
                                <div>
                                    <h5 class="mb-1">{{ _('Connected to Health Platform') }}</h5>
                                    <p class="mb-0">{{ _('This patient has an active connection to their health platform.') }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 bg-primary bg-opacity-10">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">{{ _('Connected Platform') }}</h6>                                        <p class="card-text fs-5">
                                            <i class="fas fa-heartbeat me-2 text-danger"></i>
                                            <span id="platformName" class="platform-name">-</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 bg-success bg-opacity-10">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">{{ _('Connection Date') }}</h6>
                                        <p class="card-text fs-5">
                                            <i class="fas fa-calendar-plus me-2 text-success"></i>
                                            <span id="connectionDate" class="fw-bold">-</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 bg-warning bg-opacity-10">
                                    <div class="card-body">
                                        <h6 class="card-title text-warning">{{ _('Token Expiration') }}</h6>
                                        <p class="card-text fs-5">
                                            <i class="fas fa-hourglass-half me-2 text-warning"></i>
                                            <span id="expirationDate" class="fw-bold">-</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 bg-success bg-opacity-10">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">{{ _('Status') }}</h6>
                                        <p class="card-text fs-5">
                                            <i class="fas fa-circle text-success me-2"></i>
                                            <span class="fw-bold">{{ _('Active') }}</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Il pulsante di disconnessione è stato rimosso e la funzionalità spostata nel pulsante Health Sync -->
                    </div>
                    
                    <div id="connectionInactive" class="d-none">
                        <div class="alert alert-primary mb-4">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle me-3 fs-3 text-primary"></i>
                                <div>
                                    <h5 class="mb-1">{{ _('No Active Connection') }}</h5>
                                    <p class="mb-0">{{ _('This patient does not have an active connection to a health platform.') }}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="py-4 text-center">
                            <p class="mb-4">{{ _('Click the Health Sync button above to connect to a health platform and automatically collect vital signs data.') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Section -->
        <div class="card shadow-sm mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-file-medical-alt me-2"></i> {{ _('Reports') }}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-2">
                    <a href="#" id="generateSpecificReportBtn" class="btn btn-outline-info">
                        <i class="fas fa-file-medical me-1"></i> {{ _('Generate Specific Report') }}
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8 mb-4">

        
        <!-- Vital Signs Visualization -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> {{ _('Vital Signs Trends') }}</h5>
            </div>
            <div class="card-body">
                <!-- Pulsanti per la selezione del periodo di tempo - redesigned -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i> {{ _('Periodo di visualizzazione') }}</h5>
                        <div class="period-selector">
                            <div class="btn-group period-group shadow-sm" role="group" aria-label="Periodo di tempo">
                                <button type="button" class="btn btn-light period-btn" data-period="1">
                                    <span class="period-value">1</span>
                                    <span class="period-label">{{ _('Giorno') }}</span>
                                </button>
                                <button type="button" class="btn btn-light period-btn" data-period="7">
                                    <span class="period-value">7</span>
                                    <span class="period-label">{{ _('Giorni') }}</span>
                                </button>
                                <button type="button" class="btn btn-light period-btn" data-period="30">
                                    <span class="period-value">1</span>
                                    <span class="period-label">{{ _('Mese') }}</span>
                                </button>
                                <button type="button" class="btn btn-light period-btn" data-period="90">
                                    <span class="period-value">3</span>
                                    <span class="period-label">{{ _('Mesi') }}</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs for different vital sign types -->
                <ul class="nav nav-tabs" id="vitalsChartTabs" role="tablist">
                    <!-- Verranno popolati dinamicamente con i dati disponibili dalla piattaforma collegata -->
                </ul>
                
                <div class="tab-content" id="vitalsChartTabContent">
                    <!-- Le tab verranno popolate dinamicamente -->
                    <div class="text-center py-5" id="noDataMessage">
                        <p class="text-muted mb-0">{{ _('Collegati ad una piattaforma di salute per visualizzare i dati.') }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vital Observations -->
<div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-comment-medical me-2"></i> {{ _('Observations for Current Period') }}</h5>
        <button type="button" class="btn btn-primary btn-sm" id="addObservationBtn">
            <i class="fas fa-plus me-1"></i> {{ _('Add Observation') }}
        </button>
    </div>
    <div class="card-body">
        <div id="observationsContainer">
            <!-- Observations will be loaded here -->
            <div class="text-center py-3" id="observationsLoading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">{{ _('Loading...') }}</span>
                </div>
                <p class="text-muted mt-2">{{ _('Loading observations...') }}</p>
            </div>
            
            <div id="noObservations" class="d-none">
                <p class="text-center text-muted py-3">{{ _('No observations for the current period.') }}</p>
            </div>
            
            <div id="observationsList" class="d-none">
                <!-- Observations will be added here dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Vital Signs History -->
<div class="card shadow-sm">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-history me-2"></i> {{ _('Vital Signs History') }}</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="vitalsDataTable">
                <thead>
                    <tr>
                        <th>{{ _('Type') }}</th>
                        <th>{{ _('Value') }}</th>
                        <th>{{ _('Date & Time') }}</th>
                        <th>{{ _('Source') }}</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- I dati verranno caricati dinamicamente -->
                    <tr id="noVitalsDataRow">
                        <td colspan="4" class="text-center py-3">
                            <p class="text-muted mb-0" id="vitalsTableMessage">{{ _('Caricamento dati...') }}</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Observation Modal -->
<div class="modal fade" id="observationModal" tabindex="-1" aria-labelledby="observationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="observationModalLabel">{{ _('Add Observation') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">                <!-- Form unificato per aggiunta e eliminazione osservazione -->
                <div id="observationFormContainer">
                    <form id="observationForm" method="post">
                        <input type="hidden" id="observationId" name="id">
                        <input type="hidden" id="formAction" name="action" value="add">
                        
                        <!-- Contenuto per aggiunta/modifica osservazione -->
                        <div id="addObservationContent">
                            <div class="mb-3">
                                <label for="observationType" class="form-label">{{ _('Vital Parameter') }} <span class="text-danger">*</span></label>
                                <select class="form-select" id="observationType" name="vital_type" required>
                                    <!-- These options will be populated dynamically based on available chart data -->
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="observationContent" class="form-label">{{ _('Observation') }} <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="observationContent" name="content" rows="4" required></textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="observationStartDate" class="form-label">{{ _('Start Date') }} <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="observationStartDate" name="start_date" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="observationEndDate" class="form-label">{{ _('End Date') }} <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="observationEndDate" name="end_date" required>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contenuto per eliminazione -->
                        <div id="deleteObservationContent" class="d-none">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                {{ _('Are you sure you want to delete this observation?') }}
                            </div>
                        </div>
                        
                        <div id="observationError" class="alert alert-danger mt-3" style="display: none;"></div>

                        <!-- Footer per aggiunta/modifica -->
                        <div class="modal-footer" id="modal-footer-add">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                            <button type="submit" class="btn btn-primary" id="saveObservationBtn">{{ _('Save') }}</button>
                        </div>                        
                        <!-- Footer per eliminazione -->
                        <div class="modal-footer d-none" id="modal-footer-delete">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                            <button type="button" class="btn btn-danger" id="deleteObservationBtn">{{ _('Delete') }}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Specific Report Modal -->
<div class="modal fade" id="specificReportModal" tabindex="-1" aria-labelledby="specificReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="specificReportModalLabel">{{ _('Generate Specific Report') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('views.create_specific_patient_report', patient_id=patient.id) }}" method="post" target="_blank">
                <div class="modal-body">
                    <p>{{ _('Create a customized report by selecting specific elements to include:') }}</p>
                    
                    <!-- Summary section -->
                    <div class="mb-4">
                        <label for="specific_summary" class="form-label">{{ _('Summary (Optional)') }}</label>
                        <textarea class="form-control" id="specific_summary" name="summary" rows="3" placeholder="{{ _('Add an optional summary for this report.') }}"></textarea>
                        <div class="form-text">{{ _('This summary will only be included in this report and will not be saved for future reference.') }}</div>
                    </div>
                    
                    <!-- Notes section -->
                    <h6 class="mb-2 border-bottom pb-2">{{ _('Medical Notes') }}</h6>
                    <div class="mb-4" id="notesSelectionContainer">
                        <div class="form-text mb-2">{{ _('Select notes to include in the report:') }}</div>
                        <div class="d-flex justify-content-end mb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllNotes">{{ _('Select All') }}</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="deselectAllNotes">{{ _('Deselect All') }}</button>
                        </div>
                        
                        <div class="notes-list" style="max-height: 200px; overflow-y: auto;">
                            <!-- Notes checkboxes will be loaded here dynamically -->
                            <div class="text-center py-3" id="notesLoading">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">{{ _('Loading...') }}</span>
                                </div>
                                <span class="text-muted ms-2">{{ _('Loading notes...') }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vital Types section -->
                    <h6 class="mb-2 border-bottom pb-2">{{ _('Vital Signs') }}</h6>
                    <div class="mb-4" id="vitalTypesSelectionContainer">
                        <div class="form-text mb-2">{{ _('Select vital sign types to include:') }}</div>
                        <div class="d-flex justify-content-end mb-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="selectAllVitalTypes">{{ _('Select All') }}</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="deselectAllVitalTypes">{{ _('Deselect All') }}</button>
                        </div>
                        
                        <div class="vital-types-list">
                            {% for vital_type in vital_types %}
                            <div class="vital-type-item mb-3">
                                <div class="form-check">
                                    <input class="form-check-input vital-type-checkbox" type="checkbox" id="vitalType{{ loop.index }}" name="selected_vital_types" value="{{ vital_type.value }}">
                                    <label class="form-check-label" for="vitalType{{ loop.index }}">
                                        {{ _(vital_type.value|replace('_', ' ')|title) }}
                                    </label>
                                </div>
                                
                                <div class="charts-selection ms-4 mt-2 d-none">
                                    <div class="form-text mb-1">{{ _('Select time periods for charts:') }}</div>
                                    <div class="d-flex flex-wrap gap-2">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="chart1d{{ loop.index }}" name="charts_{{ vital_type.value }}" value="1d">
                                            <label class="form-check-label" for="chart1d{{ loop.index }}">{{ _('1 Day') }}</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="chart7d{{ loop.index }}" name="charts_{{ vital_type.value }}" value="7d">
                                            <label class="form-check-label" for="chart7d{{ loop.index }}">{{ _('7 Days') }}</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="chart1m{{ loop.index }}" name="charts_{{ vital_type.value }}" value="1m">
                                            <label class="form-check-label" for="chart1m{{ loop.index }}">{{ _('1 Month') }}</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="chart3m{{ loop.index }}" name="charts_{{ vital_type.value }}" value="3m">
                                            <label class="form-check-label" for="chart3m{{ loop.index }}">{{ _('3 Months') }}</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="chart1y{{ loop.index }}" name="charts_{{ vital_type.value }}" value="1y">
                                            <label class="form-check-label" for="chart1y{{ loop.index }}">{{ _('1 Year') }}</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="observations-selection ms-4 mt-2 d-none">
                                    <div class="form-text mb-1">{{ _('Select observations:') }}</div>
                                    <div class="observations-list" data-vital-type="{{ vital_type.value }}" style="max-height: 150px; overflow-y: auto;">
                                        <!-- Observations checkboxes will be loaded here dynamically -->
                                        <div class="text-center py-2">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">{{ _('Loading...') }}</span>
                                            </div>
                                            <span class="text-muted ms-2">{{ _('Loading observations...') }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Generate Report') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<!-- Chart.js per i grafici -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/vitals.js') }}"></script>
<script src="{{ url_for('static', filename='js/health_platforms.js') }}"></script>
<script src="{{ url_for('static', filename='js/vitals_charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/observations.js') }}">
</script>
<script>
    const today = new Date();
    const isoToday = today.toISOString().split('T')[0];
    observationEndDate.max = isoToday;
    observationStartDate.max = isoToday;
</script>
<script>
    // Base URL for the application
    const BASE_URL = "{{ url_for('views.index') }}";
    // Patient ID per la pagina corrente
    const PATIENT_ID = {{ patient.id }};
    
    // Handle specific report modal
    document.getElementById('generateSpecificReportBtn').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Load notes for the specific report
        loadNotesForSpecificReport();
        
        // Load observations for each vital type
        loadObservationsForSpecificReport();
        
        // Show/hide charts and observations selections when vital type is checked/unchecked
        const vitalTypeCheckboxes = document.querySelectorAll('.vital-type-checkbox');
        vitalTypeCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const parent = this.closest('.vital-type-item');
                const chartsSelection = parent.querySelector('.charts-selection');
                const observationsSelection = parent.querySelector('.observations-selection');
                
                if (this.checked) {
                    chartsSelection.classList.remove('d-none');
                    observationsSelection.classList.remove('d-none');
                } else {
                    chartsSelection.classList.add('d-none');
                    observationsSelection.classList.add('d-none');
                }
            });
        });
        
        // Select/deselect all notes
        document.getElementById('selectAllNotes').addEventListener('click', function() {
            document.querySelectorAll('.note-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        });
        
        document.getElementById('deselectAllNotes').addEventListener('click', function() {
            document.querySelectorAll('.note-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        });
        
        // Select/deselect all vital types
        document.getElementById('selectAllVitalTypes').addEventListener('click', function() {
            document.querySelectorAll('.vital-type-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));
            });
        });
        
        document.getElementById('deselectAllVitalTypes').addEventListener('click', function() {
            document.querySelectorAll('.vital-type-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            });
        });
        
        // Open the specific report modal
        const specificReportModal = new bootstrap.Modal(document.getElementById('specificReportModal'));
        specificReportModal.show();
    });
    
    // Function to load notes for the specific report modal
    function loadNotesForSpecificReport() {
        const notesContainer = document.querySelector('#notesSelectionContainer .notes-list');
        const loadingElement = document.getElementById('notesLoading');
        
        // Show loading state
        if (loadingElement) {
            loadingElement.classList.remove('d-none');
        }
        
        fetch(`${BASE_URL}api/patients/${PATIENT_ID}/notes`)
            .then(response => response.json())
            .then(data => {
                // Hide loading state
                if (loadingElement) {
                    loadingElement.classList.add('d-none');
                }
                
                // If there are no notes
                if (data.length === 0) {
                    notesContainer.innerHTML = `<p class="text-center text-muted py-2">${translateText('No notes available')}</p>`;
                    return;
                }
                
                // Create checkboxes for each note
                let html = '';
                data.forEach(note => {
                    const date = new Date(note.created_at).toLocaleString();
                    const preview = note.content.length > 50 ? note.content.substring(0, 50) + '...' : note.content;
                    
                    html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input note-checkbox" type="checkbox" id="note${note.id}" name="selected_notes" value="${note.id}">
                        <label class="form-check-label" for="note${note.id}">
                            <span class="fw-bold">${date}</span> - ${preview}
                        </label>
                    </div>
                    `;
                });
                
                notesContainer.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading notes:', error);
                if (loadingElement) {
                    loadingElement.classList.add('d-none');
                }
                notesContainer.innerHTML = `<p class="text-center text-danger py-2">${translateText('Error loading notes')}</p>`;
            });
    }
    
    // Function to load observations for the specific report modal
    function loadObservationsForSpecificReport() {
        fetch(`${BASE_URL}api/patients/${PATIENT_ID}/observations`)
            .then(response => response.json())
            .then(data => {
                // Group observations by vital type
                const observationsByType = {};
                data.forEach(obs => {
                    if (!observationsByType[obs.vital_type]) {
                        observationsByType[obs.vital_type] = [];
                    }
                    observationsByType[obs.vital_type].push(obs);
                });
                
                // Update each observation list
                document.querySelectorAll('.observations-list').forEach(container => {
                    const vitalType = container.dataset.vitalType;
                    const observations = observationsByType[vitalType] || [];
                    
                    if (observations.length === 0) {
                        container.innerHTML = `<p class="text-center text-muted py-2">${translateText('No observations available for this vital type')}</p>`;
                        return;
                    }
                    
                    let html = '';
                    observations.forEach(obs => {
                        const startDate = new Date(obs.start_date).toLocaleDateString();
                        const endDate = new Date(obs.end_date).toLocaleDateString();
                        const preview = obs.content.length > 30 ? obs.content.substring(0, 30) + '...' : obs.content;
                        
                        html += `
                        <div class="form-check mb-2">
                            <input class="form-check-input observation-checkbox" type="checkbox" id="obs${obs.id}" name="selected_observations" value="${obs.id}">
                            <label class="form-check-label" for="obs${obs.id}">
                                <span class="fw-bold">${startDate} - ${endDate}</span>: ${preview}
                            </label>
                        </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                });
            })
            .catch(error => {
                console.error('Error loading observations:', error);
                document.querySelectorAll('.observations-list').forEach(container => {
                    container.innerHTML = `<p class="text-center text-danger py-2">${translateText('Error loading observations')}</p>`;
                });
            });
    }
</script>
{% endblock %}
