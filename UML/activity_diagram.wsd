@startuml VitaLink - Activity Diagram

' Stile e configurazione
skinparam ActivityBackgroundColor #f0f0f0
skinparam ActivityBorderColor #555555
skinparam ArrowColor #666666
skinparam ActivityDiamondBackgroundColor #f5f5f5
skinparam ActivityDiamondBorderColor #555555
skinparam ActivityStartColor #555555
skinparam ActivityEndColor #555555

title VitaLink - Activity Diagram: Collegamento Fitbit e Monitoraggio Parametri Vitali

' Inizio del processo
start

' Autenticazione medico
:Medico accede al sistema;
:Sistema autentica il medico;

' Selezione paziente
:Medico seleziona un paziente;

' Avvio integrazione con Fitbit
:Medico richiede di collegare 
dispositivo Fitbit;

' Generazione del link
:Sistema genera un link univoco
per il collegamento;

' Invio link al paziente
:Medico invia il link al paziente
(via email, SMS, ecc.);

' Fork per il paziente
fork
    :Paziente riceve il link;
    :Paziente apre il link sul suo dispositivo;
    
    ' Autorizzazione Fitbit
    :Paziente viene reindirizzato
    alla pagina di autorizzazione Fitbit;
    
    if (Il paziente autorizza l'accesso?) then (sì)
        :Fitbit reindirizza al sistema VitaLink
        con codice di autorizzazione;
        :Sistema scambia il codice di autorizzazione
        con token di accesso e refresh;
        :Sistema salva i token per il paziente;
        :Sistema mostra conferma di successo;
    else (no)
        :Fitbit reindirizza al sistema VitaLink
        con errore di autorizzazione;
        :Sistema mostra messaggio di errore;
        :Link di autorizzazione scade;
        stop
    endif
fork again
    :Medico attende conferma del collegamento;
endfork

' Join dei percorsi
:Medico vede stato aggiornato del paziente
con indicazione del collegamento Fitbit attivo;

' Sincronizzazione dati
:Medico richiede sincronizzazione
dati da Fitbit;

' Processo di sincronizzazione
:Sistema verifica validità token;

if (Token valido?) then (sì)
    :Sistema richiede dati a Fitbit API;
    
    if (Richiesta API ha successo?) then (sì)
        :Sistema elabora e memorizza i dati;
        :Sistema mostra i parametri vitali;
    else (no)
        :Sistema registra errore API;
        :Sistema notifica errore al medico;
    endif
else (no)
    :Sistema tenta refresh del token;
    
    if (Refresh riuscito?) then (sì)
        :Sistema salva nuovo token;
        :Sistema richiede dati a Fitbit API;
        :Sistema elabora e memorizza i dati;
        :Sistema mostra i parametri vitali;
    else (no)
        :Sistema imposta collegamento come non valido;
        :Sistema notifica al medico necessità
        di nuovo collegamento;
        stop
    endif
endif

' Azioni medico sui dati
:Medico visualizza grafici dei parametri vitali;

' Analisi e interpretazione
:Medico analizza i dati;

' Fork per le possibili azioni
fork
    :Medico aggiunge osservazioni
    sui parametri vitali;
fork
    :Medico aggiunge note cliniche
    sul paziente;
fork
    :Medico genera report con
    parametri selezionati;
endfork

' Fine del processo
stop

@enduml
